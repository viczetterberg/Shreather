<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Shreather — Ski Forecast</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Real-time snow conditions for backcountry skiing tours across New England and New York">
    <meta name="theme-color" content="#0f1117">
    <meta name="background-color" content="#0f1117">

    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Shreather">
    <meta name="format-detection" content="telephone=no">

    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="72x72" href="icons/icon-72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="icons/icon-96.png">
    <link rel="apple-touch-icon" sizes="128x128" href="icons/icon-128.png">
    <link rel="apple-touch-icon" sizes="144x144" href="icons/icon-144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="384x384" href="icons/icon-384.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">

    <!-- iOS Splash Screens -->
    <link rel="apple-touch-startup-image" href="icons/icon-512.png">

    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-96.png">
    <style>
        :root {
            --bg-primary: #0f1117;
            --bg-secondary: #161820;
            --bg-card: rgba(255, 255, 255, 0.03);
            --bg-card-hover: rgba(255, 255, 255, 0.055);
            --bg-input: rgba(255, 255, 255, 0.05);
            --text-primary: #e8eaed;
            --text-secondary: #8b919e;
            --text-muted: #4e5563;
            --border-color: rgba(255, 255, 255, 0.06);
            --border-subtle: rgba(255, 255, 255, 0.03);
            --accent-blue: #4a90d9;
            --accent-purple: #9080c8;
            --accent-pink: #c06068;
            --accent-red: #c06068;
            --accent-rain: #5ebda6;
            --accent-yellow: #c4983e;
            --accent-green: #5a9a6e;
            --accent-slate: #4e5e72;
            --shadow: 0 1px 3px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
            --modal-bg: rgba(8, 9, 14, 0.85);
            --radius: 6px;
            --radius-lg: 10px;
            --font: 'DM Sans', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            --mono: 'JetBrains Mono', 'SF Mono', 'Cascadia Code', monospace;
        }

        [data-theme="light"] {
            --bg-primary: #f4f3f0;
            --bg-secondary: #ffffff;
            --bg-card: rgba(0, 0, 0, 0.025);
            --bg-card-hover: rgba(0, 0, 0, 0.045);
            --bg-input: rgba(0, 0, 0, 0.035);
            --text-primary: #1a1d26;
            --text-secondary: #5c6170;
            --text-muted: #9198a5;
            --border-color: rgba(0, 0, 0, 0.08);
            --border-subtle: rgba(0, 0, 0, 0.04);
            --accent-blue: #3574b8;
            --accent-purple: #7060a8;
            --accent-pink: #a84850;
            --accent-red: #a84850;
            --accent-rain: #2e9e80;
            --accent-yellow: #a07828;
            --accent-green: #3e7a50;
            --accent-slate: #5b6a7f;
            --shadow: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
            --modal-bg: rgba(244, 243, 240, 0.92);
        }

        [data-theme="light"] header {
            background: linear-gradient(to bottom, rgba(244,243,240,0.6), rgba(244,243,240,0.9)), url('https://d9-wret.s3.us-west-2.amazonaws.com/assets/palladium/production/s3fs-public/thumbnails/image/Tuckerman-Ravine-in-Winter-White-Mountains-NH.jpg') center/cover no-repeat;
        }

        .weather-value, .stat-value, .condition-value, .forecast-snow,
        .hourly-temp, .daily-value, .tour-badge.elevation, .tour-badge.vertical, .tour-badge.pitch {
            font-family: var(--mono);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font);
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1360px;
            margin: 0 auto;
            padding: 16px 20px;
        }

        /* ─── Header ─── */
        header {
            text-align: center;
            padding: 48px 24px 40px;
            background: linear-gradient(to bottom, rgba(15,17,23,0.55), rgba(15,17,23,0.88)), url('https://d9-wret.s3.us-west-2.amazonaws.com/assets/palladium/production/s3fs-public/thumbnails/image/Tuckerman-Ravine-in-Winter-White-Mountains-NH.jpg') center/cover no-repeat;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            position: relative;
        }

        .header-controls {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 6px;
        }

        .icon-btn {
            width: 38px;
            height: 38px;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.05rem;
            transition: all 0.15s ease;
        }

        .icon-btn:hover {
            color: var(--text-primary);
            border-color: var(--text-muted);
        }

        .icon-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: transparent;
        }

        h1 {
            font-size: 1.85rem;
            font-weight: 700;
            letter-spacing: -0.03em;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 0.92rem;
            font-weight: 400;
            max-width: 520px;
            margin: 0 auto;
            line-height: 1.5;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 28px;
            flex-wrap: wrap;
        }

        .stat-item { text-align: center; }

        .stat-value {
            font-size: 1.7rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 2px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-weight: 500;
        }

        .last-updated {
            margin-top: 20px;
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        /* ─── Controls ─── */
        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .search-box {
            padding: 9px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 0.88rem;
            font-family: var(--font);
            width: 240px;
            background: var(--bg-input);
            color: var(--text-primary);
            outline: none;
            transition: all 0.15s ease;
        }

        .search-box::placeholder { color: var(--text-muted); }

        .search-box:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(74, 144, 217, 0.12);
        }

        .filter-btn {
            padding: 7px 14px;
            border: 1px solid var(--border-color);
            border-radius: 100px;
            cursor: pointer;
            font-size: 0.78rem;
            font-family: var(--font);
            font-weight: 500;
            transition: all 0.15s ease;
            background: transparent;
            color: var(--text-secondary);
        }

        .filter-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        .filter-btn.active {
            background: var(--text-primary);
            color: var(--bg-primary);
            border-color: transparent;
        }

        .sort-select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 0.82rem;
            font-family: var(--font);
            background: var(--bg-input);
            color: var(--text-primary);
            cursor: pointer;
            outline: none;
        }

        /* ─── Section Titles ─── */
        .section-title {
            font-size: 0.72rem;
            font-weight: 600;
            margin: 32px 0 16px;
            padding-bottom: 0;
            border-bottom: none;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-color);
        }

        /* ─── Card Grid ─── */
        .tours-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(330px, 1fr));
            gap: 12px;
        }

        /* ─── Tour Card ─── */
        .tour-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 18px 20px;
            transition: all 0.15s ease;
            border: 1px solid var(--border-subtle);
            cursor: pointer;
            position: relative;
        }

        .tour-card:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-color);
            box-shadow: var(--shadow);
        }

        .tour-card .favorite-btn {
            position: absolute;
            top: 14px;
            right: 14px;
            background: none;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            opacity: 0;
            transition: all 0.15s ease;
            padding: 4px;
        }

        .tour-card:hover .favorite-btn { opacity: 0.5; }
        .tour-card .favorite-btn.favorited { opacity: 1; color: var(--accent-yellow); }
        .tour-card .favorite-btn:hover { opacity: 1; }

        .tour-header {
            margin-bottom: 14px;
            padding-right: 30px;
        }

        .tour-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 3px;
            letter-spacing: -0.01em;
        }

        .tour-meta {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .tour-location {
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        .tour-badge {
            font-size: 0.65rem;
            padding: 2px 7px;
            border-radius: 3px;
            font-weight: 600;
            letter-spacing: 0.02em;
            text-transform: uppercase;
        }

        .tour-badge.book {
            background: rgba(144, 128, 200, 0.12);
            color: var(--accent-purple);
        }

        .tour-badge.gba {
            background: rgba(74, 144, 217, 0.1);
            color: var(--accent-blue);
        }

        .tour-badge.elevation {
            background: var(--bg-input);
            color: var(--text-muted);
            font-weight: 500;
        }

        .tour-badge.vertical {
            background: rgba(90, 154, 110, 0.12);
            color: var(--accent-green);
        }

        .tour-badge.ikon {
            background: rgba(196, 152, 62, 0.12);
            color: var(--accent-yellow);
        }

        .tour-badge.epic {
            background: rgba(74, 144, 217, 0.1);
            color: var(--accent-blue);
        }

        .tour-badge.indy {
            background: rgba(90, 154, 110, 0.12);
            color: var(--accent-green);
        }

        .tour-badge.difficulty-easy {
            background: rgba(90, 154, 110, 0.15);
            color: #6ec47e;
        }

        .tour-badge.difficulty-moderate {
            background: rgba(74, 144, 217, 0.12);
            color: var(--accent-blue);
        }

        .tour-badge.difficulty-difficult {
            background: rgba(196, 152, 62, 0.12);
            color: var(--accent-yellow);
        }

        .tour-badge.difficulty-expert {
            background: rgba(217, 120, 74, 0.12);
            color: var(--accent-red);
        }

        .tour-badge.difficulty-extreme {
            background: rgba(200, 60, 60, 0.18);
            color: #e05555;
        }

        .tour-badge.pitch {
            background: rgba(180, 160, 200, 0.1);
            color: var(--text-muted);
        }

        /* ─── Weather Data ─── */
        .weather-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-top: 14px;
        }

        .weather-item {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 10px 6px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        [data-theme="light"] .weather-item {
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.05);
        }

        .weather-label {
            font-size: 0.58rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-weight: 500;
        }

        .precip-legend {
            display: inline-flex;
            align-items: center;
            vertical-align: middle;
            margin-left: 3px;
            gap: 1px;
        }

        .pl-snow {
            font-size: 0.5rem;
            color: var(--accent-blue);
            line-height: 1;
        }

        .pl-rain {
            font-size: 0.35rem;
            color: var(--accent-rain);
            line-height: 1;
        }

        .precip-gradient-line {
            display: inline-block;
            width: 14px;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-rain));
            border-radius: 1px;
        }

        .legend-indicator {
            display: inline-block;
            vertical-align: middle;
            margin-left: 4px;
        }

        .legend-indicator.temp-line {
            width: 14px;
            height: 0;
            border-top: 1px solid var(--accent-red);
            opacity: 0.6;
        }

        .legend-indicator.wind-line {
            width: 14px;
            height: 0;
            border-top: 1px dashed var(--accent-yellow);
            opacity: 0.6;
        }

        .weather-value {
            font-size: 1.15rem;
            font-weight: 700;
            margin-top: 3px;
            letter-spacing: -0.02em;
        }

        .weather-value.snow { color: var(--accent-blue); }
        .weather-value.depth { color: var(--accent-purple); }
        .weather-value.temp { color: var(--accent-red); }
        .weather-value.wind { color: var(--accent-yellow); }

        /* ─── Forecast Row ─── */
        .forecast-chart {
            margin-top: 10px;
            padding: 0 2px;
        }

        .forecast-chart svg {
            display: block;
            width: 100%;
            height: auto;
            min-height: 50px;
        }


        .forecast-row {
            display: flex;
            gap: 4px;
            margin-top: 10px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .forecast-day {
            flex: 1;
            min-width: 38px;
            background: var(--bg-secondary);
            padding: 6px 3px;
            border-radius: 4px;
            text-align: center;
        }

        .forecast-day-name {
            font-size: 0.55rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-weight: 500;
        }

        .forecast-snow {
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--accent-blue);
            margin-top: 2px;
        }

        .click-hint {
            text-align: center;
            margin-top: 10px;
            font-size: 0.68rem;
            color: var(--text-muted);
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .tour-card:hover .click-hint { opacity: 1; }

        .loading {
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
            padding: 20px;
            font-size: 0.85rem;
        }

        /* ─── Modal ─── */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--modal-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 880px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .modal-title {
            font-size: 1.35rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .modal-subtitle {
            color: var(--text-secondary);
            margin-top: 3px;
            font-size: 0.85rem;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .modal-close:hover {
            background: var(--accent-red);
            color: white;
            border-color: transparent;
        }

        .modal-body { padding: 24px 28px; }

        .modal-section { margin-bottom: 28px; }

        .modal-section-title {
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        /* ─── Current Conditions ─── */
        .current-conditions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .condition-card {
            background: rgba(255, 255, 255, 0.035);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 16px 12px;
            border-radius: var(--radius);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        [data-theme="light"] .condition-card {
            background: rgba(0, 0, 0, 0.025);
            border-color: rgba(0, 0, 0, 0.06);
        }

        .condition-icon {
            font-size: 1.4rem;
            margin-bottom: 6px;
        }

        .condition-value {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .condition-label {
            font-size: 0.62rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-top: 3px;
            font-weight: 500;
        }

        /* ─── Hourly Forecast ─── */
        .hourly-chart {
            margin-top: 6px;
        }

        .hourly-chart {
            position: relative;
            cursor: crosshair;
        }

        .hourly-chart svg {
            display: block;
            width: 100%;
            height: auto;
            min-height: 100px;
        }

        .hc-tooltip {
            display: none;
            position: absolute;
            top: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 0.72rem;
            font-family: var(--mono);
            line-height: 1.5;
            pointer-events: none;
            z-index: 10;
            white-space: nowrap;
            box-shadow: var(--shadow-lg);
        }

        .hc-tooltip.visible {
            display: block;
        }

        .hc-tooltip .tt-time {
            font-family: var(--font);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .hc-tooltip .tt-snow { color: var(--accent-blue); }
        .hc-tooltip .tt-rain { color: var(--accent-rain); }
        .hc-tooltip .tt-temp { color: var(--accent-red); }
        .hc-tooltip .tt-wind { color: var(--accent-yellow); }

        .hourly-chart-legend {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .hcl-item {
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }

        .hourly-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 8px 0;
        }

        .hourly-item {
            flex: 0 0 auto;
            background: var(--bg-card);
            padding: 12px;
            border-radius: var(--radius);
            text-align: center;
            min-width: 72px;
            border: 1px solid var(--border-subtle);
        }

        .hourly-time {
            font-size: 0.68rem;
            color: var(--text-muted);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .hourly-temp {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .hourly-snow {
            font-size: 0.78rem;
            color: var(--accent-blue);
            margin-top: 3px;
            font-weight: 500;
        }

        .hourly-wind {
            font-size: 0.68rem;
            color: var(--text-muted);
            margin-top: 3px;
        }

        /* ─── Daily Forecast ─── */
        .daily-forecast {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .daily-item {
            display: grid;
            grid-template-columns: 90px 1fr repeat(4, 72px);
            align-items: center;
            padding: 12px 14px;
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border-subtle);
            gap: 12px;
        }

        .daily-day {
            font-weight: 600;
            font-size: 0.88rem;
            color: var(--text-primary);
        }

        .daily-date {
            font-size: 0.72rem;
            color: var(--text-muted);
        }

        .daily-bar {
            height: 4px;
            background: var(--bg-primary);
            border-radius: 2px;
            overflow: hidden;
        }

        .daily-bar-fill {
            height: 100%;
            background: var(--accent-blue);
            border-radius: 2px;
        }

        .daily-value {
            text-align: center;
            font-size: 0.82rem;
        }

        .daily-value.snow { color: var(--accent-blue); font-weight: 600; }
        .daily-value.rain { color: var(--accent-rain); }
        .daily-value.temp { color: var(--text-primary); }
        .daily-value.wind { color: var(--accent-yellow); }

        .daily-label {
            font-size: 0.58rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-weight: 500;
        }

        /* ─── Location Info ─── */
        .location-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }

        .info-item {
            background: var(--bg-card);
            padding: 14px;
            border-radius: var(--radius);
            border: 1px solid var(--border-subtle);
        }

        .info-label {
            font-size: 0.62rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .info-value {
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .info-value a {
            color: var(--accent-blue);
            text-decoration: none;
        }

        .info-value a:hover { text-decoration: underline; }

        /* ─── Modal Mini Map ─── */
        .modal-map {
            width: 100%;
            height: 200px;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        /* ─── Daily Forecast Table ─── */
        .forecast-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
        }

        .forecast-table th {
            text-align: left;
            padding: 8px 10px;
            font-size: 0.62rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            border-bottom: 1px solid var(--border-color);
        }

        .forecast-table th:not(:first-child) {
            text-align: right;
        }

        .forecast-table td {
            padding: 9px 10px;
            border-bottom: 1px solid var(--border-subtle);
            font-family: var(--mono);
            font-size: 0.78rem;
        }

        .forecast-table td:not(:first-child) {
            text-align: right;
        }

        .forecast-table td:first-child {
            font-family: var(--font);
            font-weight: 500;
            color: var(--text-primary);
        }

        .forecast-table tr:last-child td {
            border-bottom: none;
        }

        .forecast-table .snow-val { color: var(--accent-blue); font-weight: 600; }
        .forecast-table .rain-val { color: var(--accent-rain); }
        .forecast-table .temp-val { color: var(--text-secondary); }
        .forecast-table .wind-val { color: var(--accent-yellow); }

        .forecast-table .snow-bar {
            display: inline-block;
            height: 3px;
            background: var(--accent-blue);
            border-radius: 1px;
            margin-right: 6px;
            vertical-align: middle;
        }

        .day-row .expand-arrow {
            display: inline-block;
            font-size: 0.6rem;
            color: var(--text-muted);
            transition: transform 0.2s ease;
            vertical-align: middle;
            margin-left: 2px;
        }

        .day-row.expanded .expand-arrow {
            transform: rotate(90deg);
        }

        .day-row:hover {
            background: var(--bg-card-hover);
        }

        .hourly-detail-row {
            display: none;
        }

        .hourly-detail-row.show {
            display: table-row;
        }

        .hourly-detail-row td {
            padding: 5px 10px !important;
            font-size: 0.72rem !important;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-subtle) !important;
        }

        .hourly-detail-row td.he-time {
            font-family: var(--font);
            font-weight: 500;
            color: var(--text-muted);
        }

        /* ─── Footer ─── */
        footer {
            text-align: center;
            padding: 32px 20px;
            margin-top: 40px;
            color: var(--text-muted);
            font-size: 0.78rem;
            border-top: 1px solid var(--border-color);
            line-height: 1.6;
        }

        footer a {
            color: var(--text-secondary);
            text-decoration: none;
        }

        footer a:hover { text-decoration: underline; }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        /* ─── Responsive ─── */
        @media (max-width: 768px) {
            h1 { font-size: 1.5rem; }

            .header-controls {
                position: static;
                justify-content: center;
                margin-top: 16px;
            }

            .tours-grid { grid-template-columns: 1fr; }
            .search-box { width: 100%; }

            .controls {
                gap: 6px;
            }

            .filter-btn { padding: 6px 12px; font-size: 0.74rem; }

            .weather-grid { grid-template-columns: repeat(2, 1fr); }

            .daily-item {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .daily-bar { display: none; }
            .modal-body { padding: 16px; }
            .modal-header { padding: 18px 16px; }
            .current-conditions { grid-template-columns: repeat(2, 1fr); }
            .container { padding: 10px 12px; }
        }

        /* ─── View Toggle ─── */
        .view-toggle {
            display: inline-flex;
            border: 1px solid var(--border-color);
            border-radius: 100px;
            overflow: hidden;
            background: var(--bg-input);
        }

        .view-toggle-btn {
            padding: 8px 22px;
            border: none;
            cursor: pointer;
            font-size: 0.82rem;
            font-family: var(--font);
            font-weight: 500;
            background: transparent;
            color: var(--text-muted);
            transition: all 0.15s ease;
        }

        .view-toggle-btn.active {
            background: var(--text-primary);
            color: var(--bg-primary);
            border-radius: 100px;
        }

        .view-toggle-btn:hover:not(.active) {
            color: var(--text-primary);
        }

        /* ─── Map ─── */
        #map-container {
            display: none;
            height: 72vh;
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        #map-container.active { display: block; }
        #map { width: 100%; height: 100%; }

        .snow-marker { background: none; border: none; }

        .snow-marker-label {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 22px;
            padding: 0 6px;
            border-radius: 4px;
            font-family: var(--mono);
            font-size: 0.7rem;
            font-weight: 700;
            color: #fff;
            white-space: nowrap;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }

        .snow-marker-label.has-snow { background: var(--accent-blue); }
        .snow-marker-label.no-snow { background: var(--accent-slate); opacity: 0.6; }
        .snow-marker-label.has-wind { background: var(--accent-yellow); }
        .snow-marker-label.hot { background: var(--accent-red); }
        .snow-marker-label.cold { background: var(--accent-blue); }

        .leaflet-popup-content-wrapper {
            background: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
            border-radius: var(--radius) !important;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg) !important;
            font-family: var(--font);
        }

        .leaflet-popup-tip { background: var(--bg-secondary) !important; }

        .leaflet-popup-content {
            margin: 12px 14px !important;
            font-size: 0.85rem;
        }

        .leaflet-popup-content .popup-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 3px;
        }

        .leaflet-popup-content .popup-region {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-bottom: 8px;
        }

        .leaflet-popup-content .popup-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            margin-bottom: 8px;
            font-family: var(--mono);
            font-size: 0.78rem;
        }

        .leaflet-popup-content .popup-stats span { color: var(--text-muted); }

        .leaflet-popup-content .popup-detail-btn {
            display: block;
            width: 100%;
            padding: 6px;
            background: var(--text-primary);
            color: var(--bg-primary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            font-family: var(--font);
            font-weight: 500;
            text-align: center;
        }

        .leaflet-popup-content .popup-detail-btn:hover { opacity: 0.85; }

        /* ─── Scrollbar ─── */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* ─── iOS PWA ─── */
        @supports (padding-top: env(safe-area-inset-top)) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
        }

        .ios-standalone header {
            padding-top: calc(20px + env(safe-area-inset-top, 20px));
        }

        .ios-standalone .modal { padding-top: env(safe-area-inset-top); }

        .offline::before {
            content: 'Offline — showing cached data';
            position: fixed;
            top: 0; left: 0; right: 0;
            background: var(--accent-yellow);
            color: #000;
            text-align: center;
            padding: 6px;
            font-size: 0.78rem;
            font-weight: 500;
            z-index: 9999;
        }

        .offline .container { margin-top: 36px; }

        .ios-standalone .last-updated::after {
            content: ' · Pull to refresh';
            opacity: 0.6;
        }

        /* ─── Install Prompt ─── */
        .install-prompt {
            position: fixed;
            bottom: 16px;
            left: 16px;
            right: 16px;
            max-width: 400px;
            margin: 0 auto;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 20px;
            display: none;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }

        .install-prompt.show { display: block; }

        .install-prompt h3 {
            margin-bottom: 8px;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .install-prompt p {
            color: var(--text-secondary);
            font-size: 0.82rem;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .install-prompt .steps {
            background: var(--bg-card);
            padding: 12px 14px;
            border-radius: var(--radius);
            margin-bottom: 14px;
        }

        .install-prompt .steps li {
            margin: 6px 0;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .install-prompt button {
            padding: 8px 18px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.82rem;
            font-family: var(--font);
            font-weight: 500;
        }

        .install-prompt .dismiss {
            background: var(--bg-card);
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-controls">
                <button class="icon-btn" id="favorites-toggle" title="Show favorites only">
                    <span>&#9733;</span>
                </button>
                <button class="icon-btn" id="theme-toggle" title="Toggle dark/light mode">
                    <span id="theme-icon">&#9788;</span>
                </button>
            </div>
            <h1>Shreather</h1>
            <p class="subtitle">Ski forecast for backcountry tours, glades, and resorts across the Northeast</p>
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="total-tours">0</div>
                    <div class="stat-label">Total Tours</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="snow-tours">0</div>
                    <div class="stat-label">With Snow</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="best-snow">0"</div>
                    <div class="stat-label">Best Depth</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="favorites-count">0</div>
                    <div class="stat-label">Favorites</div>
                </div>
            </div>
            <p class="last-updated">Last updated: <span id="update-time">Loading...</span></p>
        </header>

        <div class="controls">
            <input type="text" class="search-box" placeholder="Search tours..." id="search-input">
            <select class="sort-select" id="sort-select">
                <option value="name">Sort by Name</option>
                <option value="snow-desc">Most Snow Depth</option>
                <option value="snow-asc">Least Snow Depth</option>
                <option value="elevation-desc">Highest Elevation</option>
                <option value="elevation-asc">Lowest Elevation</option>
                <option value="forecast">Best Forecast</option>
            </select>
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="book">Book Tours</button>
            <button class="filter-btn" data-filter="gba">GBA Glades</button>
            <button class="filter-btn" data-filter="ikon">Ikon</button>
            <button class="filter-btn" data-filter="epic">Epic</button>
            <button class="filter-btn" data-filter="indy">Indy</button>
            <button class="filter-btn" data-filter="nh">NH</button>
            <button class="filter-btn" data-filter="vt">VT</button>
            <button class="filter-btn" data-filter="me">ME</button>
            <button class="filter-btn" data-filter="ny">NY</button>
            <button class="filter-btn" data-filter="ma">MA</button>
            <button class="filter-btn" data-filter="pa">PA</button>
        </div>

        <div style="text-align:center;margin-bottom:20px;display:flex;justify-content:center;align-items:center;gap:12px;flex-wrap:wrap;">
            <div class="view-toggle">
                <button class="view-toggle-btn active" id="card-view-btn">Cards</button>
                <button class="view-toggle-btn" id="map-view-btn">Map</button>
            </div>
            <select class="sort-select" id="map-metric-select" style="display:none;">
                <option value="snow-tomorrow">Snow Tomorrow</option>
                <option value="wind">Wind (mph)</option>
                <option value="temp">Temp (&deg;F)</option>
                <option value="best-day">Best Day (5-day)</option>
            </select>
        </div>
        <div id="map-container"><div id="map"></div></div>
        <div id="tours-container"></div>
    </div>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal" id="modal">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title" id="modal-title">Tour Name</h2>
                    <p class="modal-subtitle" id="modal-subtitle">Location</p>
                </div>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Content populated by JS -->
            </div>
        </div>
    </div>

    <footer>
        <p>Data sources: <a href="https://bestbackcountryskiing.com/" target="_blank">Best Backcountry Skiing in the Northeast</a> by David Goodman | <a href="https://granitebackcountryalliance.org/" target="_blank">Granite Backcountry Alliance</a></p>
        <p style="margin-top: 10px;">Weather data from <a href="https://open-meteo.com/" target="_blank">Open-Meteo API</a> | Snow depth from <a href="https://www.nohrsc.noaa.gov/nsa/" target="_blank">NOAA National Snow Analysis</a></p>
        <p style="margin-top: 15px; font-size: 0.8rem;">Snow depth is from NOAA's daily snow analysis (observed + modeled at 1km resolution) and may not exactly match trail conditions. Always check local reports and avalanche forecasts before heading out.</p>
    </footer>

    <!-- iOS Install Prompt -->
    <div class="install-prompt" id="install-prompt">
        <h3>Install Shreather App</h3>
        <p>Add this app to your home screen for the best experience:</p>
        <ol class="steps">
            <li>Tap the <strong>Share</strong> button <span style="font-size: 1.2em;">&#8593;</span> at the bottom of Safari</li>
            <li>Scroll down and tap <strong>"Add to Home Screen"</strong></li>
            <li>Tap <strong>"Add"</strong> in the top right</li>
        </ol>
        <button class="dismiss" onclick="dismissInstallPrompt()">Got it!</button>
    </div>

    <script>
        // ==================== DATA ====================
        const tours = [
            // NEW HAMPSHIRE - Book Tours
            { id: 1, name: "Mt. Cardigan", state: "NH", region: "Western NH", lat: 43.6497, lon: -71.9148, elevation: 3155, vertical: 1900, maxPitch: 25, difficulty: "moderate", source: ["book"] },
            { id: 2, name: "Mt. Monadnock", state: "NH", region: "Southern NH", lat: 42.8612, lon: -72.1092, elevation: 3165, vertical: 1800, maxPitch: 28, difficulty: "moderate", source: ["book"] },
            { id: 3, name: "Mt. Moosilauke", state: "NH", region: "Western Whites", lat: 44.0245, lon: -71.8309, elevation: 4802, vertical: 3200, maxPitch: 32, difficulty: "difficult", source: ["book"] },
            { id: 4, name: "Mt. Chocorua", state: "NH", region: "Sandwich Range", lat: 43.9542, lon: -71.2734, elevation: 3490, vertical: 2400, maxPitch: 30, difficulty: "difficult", source: ["book"] },
            { id: 5, name: "Cannon Mountain", state: "NH", region: "Franconia", lat: 44.1565, lon: -71.6984, elevation: 4080, vertical: 2180, maxPitch: 35, difficulty: "difficult", source: ["book", "indy"] },
            { id: 6, name: "Mt. Garfield", state: "NH", region: "Franconia", lat: 44.1870, lon: -71.6109, elevation: 4500, vertical: 3000, maxPitch: 30, difficulty: "difficult", source: ["book"] },
            { id: 7, name: "Carter Notch Hut Tours", state: "NH", region: "Carter Range", lat: 44.2592, lon: -71.1958, elevation: 3388, vertical: 1800, maxPitch: 22, difficulty: "moderate", source: ["book"] },
            { id: 8, name: "Wildcat Valley Trail", state: "NH", region: "Carter Range", lat: 44.2631, lon: -71.2392, elevation: 4422, vertical: 2100, maxPitch: 28, difficulty: "difficult", source: ["book"] },
            { id: 9, name: "Doublehead Ski Trail", state: "NH", region: "Jackson", lat: 44.1317, lon: -71.1103, elevation: 3053, vertical: 1573, maxPitch: 28, difficulty: "moderate", source: ["book"] },
            { id: 10, name: "Avalanche Brook Trail", state: "NH", region: "Mt. Washington", lat: 44.2706, lon: -71.3033, elevation: 4000, vertical: 1800, maxPitch: 25, difficulty: "moderate", source: ["book"] },
            { id: 11, name: "Pinkham Notch Tours", state: "NH", region: "Mt. Washington", lat: 44.2572, lon: -71.2533, elevation: 2032, vertical: 800, maxPitch: 18, difficulty: "easy", source: ["book"] },
            { id: 12, name: "Gulf of Slides", state: "NH", region: "Mt. Washington", lat: 44.2567, lon: -71.2553, elevation: 4100, vertical: 2100, maxPitch: 40, difficulty: "expert", source: ["book"] },
            { id: 13, name: "Sherburne Ski Trail", state: "NH", region: "Mt. Washington", lat: 44.2631, lon: -71.2748, elevation: 3950, vertical: 1918, maxPitch: 30, difficulty: "difficult", source: ["book"] },
            { id: 14, name: "Tuckerman Ravine", state: "NH", region: "Mt. Washington", lat: 44.2631, lon: -71.2748, elevation: 4400, vertical: 2400, maxPitch: 50, difficulty: "extreme", source: ["book"] },
            { id: 15, name: "Great Gulf", state: "NH", region: "Mt. Washington", lat: 44.2867, lon: -71.2850, elevation: 4000, vertical: 2000, maxPitch: 35, difficulty: "expert", source: ["book"] },
            { id: 16, name: "Oakes Gulf", state: "NH", region: "Mt. Washington", lat: 44.2500, lon: -71.2917, elevation: 4600, vertical: 2400, maxPitch: 42, difficulty: "extreme", source: ["book"] },
            { id: 17, name: "Zealand Falls Hut Tour", state: "NH", region: "Pemigewasset", lat: 44.1956, lon: -71.4942, elevation: 2630, vertical: 800, maxPitch: 15, difficulty: "easy", source: ["book"] },
            { id: 18, name: "Zealand Notch Tours", state: "NH", region: "Pemigewasset", lat: 44.1900, lon: -71.4800, elevation: 2500, vertical: 700, maxPitch: 12, difficulty: "easy", source: ["book"] },
            { id: 19, name: "Pemigewasset River Tours", state: "NH", region: "Pemigewasset", lat: 44.1500, lon: -71.5500, elevation: 2000, vertical: 500, maxPitch: 10, difficulty: "easy", source: ["book"] },
            { id: 20, name: "Greeley Ponds", state: "NH", region: "Kancamagus", lat: 44.0167, lon: -71.5167, elevation: 2200, vertical: 600, maxPitch: 12, difficulty: "easy", source: ["book"] },
            { id: 21, name: "Easy Day Trips (White Mtns)", state: "NH", region: "White Mountains", lat: 44.2000, lon: -71.4000, elevation: 2500, vertical: 800, maxPitch: 15, difficulty: "easy", source: ["book"] },

            // NEW HAMPSHIRE - Ski Resorts
            { id: 64, name: "Loon Mountain", state: "NH", region: "Lincoln", lat: 44.0346, lon: -71.6208, elevation: 3050, vertical: 2100, maxPitch: 35, difficulty: "difficult", source: ["ikon"] },
            { id: 65, name: "Mount Sunapee", state: "NH", region: "Newbury", lat: 43.3141, lon: -72.0744, elevation: 2743, vertical: 1510, maxPitch: 32, difficulty: "moderate", source: ["ikon", "epic"] },
            { id: 66, name: "Cranmore Mountain", state: "NH", region: "North Conway", lat: 44.0576, lon: -71.0928, elevation: 2000, vertical: 1200, maxPitch: 30, difficulty: "moderate", source: ["ikon"] },
            { id: 67, name: "Attitash Mountain", state: "NH", region: "Bartlett", lat: 44.0465, lon: -71.2312, elevation: 2350, vertical: 1750, maxPitch: 35, difficulty: "difficult", source: ["epic"] },
            { id: 68, name: "Wildcat Mountain", state: "NH", region: "Pinkham Notch", lat: 44.2700, lon: -71.2100, elevation: 4422, vertical: 2112, maxPitch: 38, difficulty: "expert", source: ["epic"] },
            { id: 69, name: "Crotched Mountain", state: "NH", region: "Bennington", lat: 42.9981, lon: -71.8740, elevation: 2066, vertical: 875, maxPitch: 28, difficulty: "moderate", source: ["epic"] },
            { id: 70, name: "Waterville Valley", state: "NH", region: "Waterville Valley", lat: 43.9673, lon: -71.5581, elevation: 4004, vertical: 2020, maxPitch: 35, difficulty: "difficult", source: ["indy"] },
            { id: 71, name: "Pats Peak", state: "NH", region: "Henniker", lat: 43.2000, lon: -71.5600, elevation: 1800, vertical: 770, maxPitch: 28, difficulty: "moderate", source: ["indy"] },
            { id: 72, name: "Dartmouth Skiway", state: "NH", region: "Lyme", lat: 43.7870, lon: -72.1004, elevation: 2500, vertical: 968, maxPitch: 30, difficulty: "moderate", source: ["indy"] },
            { id: 73, name: "Black Mountain", state: "NH", region: "Jackson", lat: 44.0554, lon: -71.1525, elevation: 1750, vertical: 1100, maxPitch: 30, difficulty: "moderate", source: ["indy"] },
            { id: 74, name: "Tenney Mountain", state: "NH", region: "Plymouth", lat: 43.7359, lon: -71.7934, elevation: 2070, vertical: 1450, maxPitch: 35, difficulty: "difficult", source: ["indy"] },

            // VERMONT - Book Tours
            { id: 22, name: "Stratton Pond", state: "VT", region: "Southern VT", lat: 43.0833, lon: -72.9333, elevation: 2600, vertical: 600, maxPitch: 12, difficulty: "easy", source: ["book"] },
            { id: 23, name: "Skyline Trail", state: "VT", region: "Southern VT", lat: 43.1500, lon: -72.9000, elevation: 3900, vertical: 2200, maxPitch: 28, difficulty: "moderate", source: ["book"] },
            { id: 24, name: "Mt. Moosalamoo", state: "VT", region: "Central VT", lat: 43.9333, lon: -73.0167, elevation: 2640, vertical: 1200, maxPitch: 20, difficulty: "moderate", source: ["book"] },
            { id: 25, name: "Breadloaf Wilderness/Norske Trail", state: "VT", region: "Central VT", lat: 43.9667, lon: -72.9500, elevation: 3800, vertical: 1600, maxPitch: 22, difficulty: "moderate", source: ["book"] },
            { id: 26, name: "Woodward Mountain Trail", state: "VT", region: "Central VT", lat: 44.0000, lon: -72.9000, elevation: 3100, vertical: 1400, maxPitch: 25, difficulty: "moderate", source: ["book"] },
            { id: 27, name: "Bolton-Trapp Trail", state: "VT", region: "Northern VT", lat: 44.4167, lon: -72.8667, elevation: 3200, vertical: 1200, maxPitch: 20, difficulty: "moderate", source: ["book"] },
            { id: 28, name: "Long Trail - Monroe Skyline", state: "VT", region: "Northern VT", lat: 44.3000, lon: -72.8500, elevation: 4000, vertical: 2500, maxPitch: 30, difficulty: "difficult", source: ["book"] },
            { id: 29, name: "Camel's Hump", state: "VT", region: "Northern VT", lat: 44.3194, lon: -72.8861, elevation: 4083, vertical: 2800, maxPitch: 35, difficulty: "expert", source: ["book"] },
            { id: 30, name: "Lake Willoughby", state: "VT", region: "Northeast Kingdom", lat: 44.7500, lon: -72.0333, elevation: 2600, vertical: 1400, maxPitch: 35, difficulty: "difficult", source: ["book"] },
            { id: 31, name: "Big Jay", state: "VT", region: "Jay Peak", lat: 44.9500, lon: -72.5167, elevation: 3800, vertical: 2000, maxPitch: 35, difficulty: "expert", source: ["book"] },
            { id: 32, name: "Bruce Trail", state: "VT", region: "Mt. Mansfield", lat: 44.5433, lon: -72.8142, elevation: 4393, vertical: 2600, maxPitch: 38, difficulty: "expert", source: ["book"] },
            { id: 33, name: "Teardrop Trail", state: "VT", region: "Mt. Mansfield", lat: 44.5433, lon: -72.8142, elevation: 4000, vertical: 2200, maxPitch: 40, difficulty: "expert", source: ["book"] },
            { id: 34, name: "Skytop Trail", state: "VT", region: "Mt. Mansfield", lat: 44.5433, lon: -72.8142, elevation: 4000, vertical: 2000, maxPitch: 35, difficulty: "expert", source: ["book"] },
            { id: 35, name: "Steeple Trail", state: "VT", region: "Mt. Mansfield", lat: 44.5433, lon: -72.8142, elevation: 3800, vertical: 1800, maxPitch: 38, difficulty: "expert", source: ["book"] },
            { id: 36, name: "Nebraska Notch", state: "VT", region: "Mt. Mansfield", lat: 44.5000, lon: -72.8333, elevation: 2800, vertical: 800, maxPitch: 18, difficulty: "easy", source: ["book"] },

            // VERMONT - Ski Resorts
            { id: 75, name: "Stratton Mountain", state: "VT", region: "Southern VT", lat: 43.0865, lon: -72.9259, elevation: 3940, vertical: 2003, maxPitch: 38, difficulty: "difficult", source: ["ikon"] },
            { id: 76, name: "Sugarbush Resort", state: "VT", region: "Warren", lat: 44.1200, lon: -72.8300, elevation: 4083, vertical: 2650, maxPitch: 38, difficulty: "expert", source: ["ikon"] },
            { id: 77, name: "Killington", state: "VT", region: "Killington", lat: 43.6045, lon: -72.8201, elevation: 4229, vertical: 3050, maxPitch: 40, difficulty: "expert", source: ["ikon"] },
            { id: 78, name: "Stowe Mountain", state: "VT", region: "Stowe", lat: 44.5297, lon: -72.7793, elevation: 4395, vertical: 2360, maxPitch: 40, difficulty: "expert", source: ["ikon", "epic"] },
            { id: 79, name: "Okemo Mountain", state: "VT", region: "Ludlow", lat: 43.4008, lon: -72.7167, elevation: 3344, vertical: 2200, maxPitch: 35, difficulty: "difficult", source: ["ikon", "epic"] },
            { id: 80, name: "Mount Snow", state: "VT", region: "West Dover", lat: 42.9590, lon: -72.9237, elevation: 3600, vertical: 1700, maxPitch: 35, difficulty: "difficult", source: ["ikon", "epic"] },
            { id: 81, name: "Jay Peak", state: "VT", region: "Jay", lat: 44.9245, lon: -72.5257, elevation: 3862, vertical: 2153, maxPitch: 40, difficulty: "expert", source: ["indy"] },
            { id: 82, name: "Burke Mountain", state: "VT", region: "East Burke", lat: 44.5712, lon: -71.8923, elevation: 3258, vertical: 2011, maxPitch: 35, difficulty: "difficult", source: ["indy"] },
            { id: 83, name: "Bolton Valley", state: "VT", region: "Bolton", lat: 44.4492, lon: -72.8396, elevation: 3150, vertical: 1704, maxPitch: 32, difficulty: "difficult", source: ["indy"] },
            { id: 84, name: "Magic Mountain", state: "VT", region: "Londonderry", lat: 43.2000, lon: -72.7700, elevation: 2850, vertical: 1500, maxPitch: 42, difficulty: "expert", source: ["indy"] },

            // MAINE - Book Tours
            { id: 37, name: "Acadia National Park", state: "ME", region: "Coastal Maine", lat: 44.3386, lon: -68.2733, elevation: 1530, vertical: 1000, maxPitch: 22, difficulty: "moderate", source: ["book"] },
            { id: 38, name: "Camden Hills State Park", state: "ME", region: "Midcoast Maine", lat: 44.2333, lon: -69.0667, elevation: 1380, vertical: 900, maxPitch: 20, difficulty: "easy", source: ["book"] },
            { id: 39, name: "Katahdin & Baxter State Park", state: "ME", region: "Northern Maine", lat: 45.9044, lon: -68.9214, elevation: 5269, vertical: 4200, maxPitch: 45, difficulty: "extreme", source: ["book"] },
            { id: 40, name: "100 Mile Wilderness", state: "ME", region: "Northern Maine", lat: 45.5000, lon: -69.2500, elevation: 2000, vertical: 800, maxPitch: 15, difficulty: "easy", source: ["book"] },
            { id: 41, name: "Grand Canyon of Maine", state: "ME", region: "Northern Maine", lat: 45.4833, lon: -69.4500, elevation: 1800, vertical: 600, maxPitch: 18, difficulty: "moderate", source: ["book"] },
            { id: 42, name: "Maine Huts", state: "ME", region: "Western Maine", lat: 45.0833, lon: -70.2167, elevation: 2500, vertical: 1000, maxPitch: 15, difficulty: "easy", source: ["book"] },

            // MAINE - Ski Resorts
            { id: 85, name: "Sunday River", state: "ME", region: "Newry", lat: 44.4683, lon: -70.8567, elevation: 3140, vertical: 2340, maxPitch: 38, difficulty: "expert", source: ["ikon"] },
            { id: 86, name: "Sugarloaf", state: "ME", region: "Carrabassett Valley", lat: 45.0317, lon: -70.3133, elevation: 4237, vertical: 2820, maxPitch: 42, difficulty: "expert", source: ["ikon"] },
            { id: 87, name: "Big Rock", state: "ME", region: "Mars Hill", lat: 46.5220, lon: -67.8297, elevation: 1610, vertical: 980, maxPitch: 28, difficulty: "moderate", source: ["indy"] },
            { id: 88, name: "Mt. Abram", state: "ME", region: "Greenwood", lat: 44.3800, lon: -70.7200, elevation: 2000, vertical: 1150, maxPitch: 30, difficulty: "moderate", source: ["indy"] },
            { id: 95, name: "Saddleback Mountain", state: "ME", region: "Rangeley", lat: 44.9417, lon: -70.5153, elevation: 4120, vertical: 2000, maxPitch: 38, difficulty: "expert", source: ["indy"] },
            { id: 96, name: "Black Mountain of Maine", state: "ME", region: "Rumford", lat: 44.5800, lon: -70.6200, elevation: 2214, vertical: 1100, maxPitch: 30, difficulty: "moderate", source: ["indy"] },
            { id: 97, name: "Camden Snow Bowl", state: "ME", region: "Camden", lat: 44.1833, lon: -69.0833, elevation: 1300, vertical: 950, maxPitch: 30, difficulty: "moderate", source: ["indy"] },

            // NEW YORK - Book Tours
            { id: 43, name: "Jackrabbit Trail", state: "NY", region: "Adirondacks", lat: 44.2833, lon: -74.0000, elevation: 2000, vertical: 600, maxPitch: 12, difficulty: "easy", source: ["book"] },
            { id: 44, name: "Camp Peggy O'Brien Hut Tour", state: "NY", region: "Adirondacks", lat: 44.1167, lon: -74.0500, elevation: 2800, vertical: 1200, maxPitch: 18, difficulty: "moderate", source: ["book"] },
            { id: 45, name: "Wright Peak Ski Trail", state: "NY", region: "Adirondacks", lat: 44.1517, lon: -73.9808, elevation: 4580, vertical: 3400, maxPitch: 38, difficulty: "expert", source: ["book"] },
            { id: 46, name: "Avalanche Pass & Lake Colden", state: "NY", region: "Adirondacks", lat: 44.1333, lon: -73.9667, elevation: 2800, vertical: 1200, maxPitch: 20, difficulty: "moderate", source: ["book"] },
            { id: 47, name: "Mt. Marcy", state: "NY", region: "Adirondacks", lat: 44.1128, lon: -73.9237, elevation: 5344, vertical: 3200, maxPitch: 35, difficulty: "expert", source: ["book"] },

            // NEW YORK - Ski Resorts
            { id: 89, name: "Hunter Mountain", state: "NY", region: "Hunter", lat: 42.1779, lon: -74.2304, elevation: 3200, vertical: 1600, maxPitch: 38, difficulty: "difficult", source: ["epic"] },
            { id: 90, name: "Greek Peak", state: "NY", region: "Virgil", lat: 42.5100, lon: -76.1400, elevation: 2100, vertical: 952, maxPitch: 30, difficulty: "moderate", source: ["indy"] },
            { id: 91, name: "Titus Mountain", state: "NY", region: "Malone", lat: 44.7600, lon: -74.2300, elevation: 2025, vertical: 1200, maxPitch: 28, difficulty: "moderate", source: ["indy"] },

            // MASSACHUSETTS - Book Tours
            { id: 48, name: "Thunderbolt Ski Trail", state: "MA", region: "Berkshires", lat: 42.6375, lon: -73.1667, elevation: 3491, vertical: 2175, maxPitch: 40, difficulty: "extreme", source: ["book"] },

            // MASSACHUSETTS - Ski Resorts
            { id: 92, name: "Jiminy Peak", state: "MA", region: "Hancock", lat: 42.5442, lon: -73.2862, elevation: 2380, vertical: 1150, maxPitch: 30, difficulty: "moderate", source: ["ikon"] },
            { id: 93, name: "Bousquet Mountain", state: "MA", region: "Pittsfield", lat: 42.4190, lon: -73.2770, elevation: 1875, vertical: 750, maxPitch: 28, difficulty: "moderate", source: ["indy"] },
            { id: 98, name: "Berkshire East", state: "MA", region: "Charlemont", lat: 42.6258, lon: -72.8806, elevation: 1980, vertical: 1180, maxPitch: 32, difficulty: "moderate", source: ["indy"] },
            { id: 99, name: "Catamount", state: "MA", region: "South Egremont", lat: 42.1692, lon: -73.4847, elevation: 1000, vertical: 1000, maxPitch: 30, difficulty: "moderate", source: ["indy"] },

            // PENNSYLVANIA - Ski Resorts
            { id: 94, name: "Ski Big Bear", state: "PA", region: "Lackawaxen", lat: 41.4866, lon: -75.0592, elevation: 2175, vertical: 650, maxPitch: 25, difficulty: "moderate", source: ["indy"] },

            // GBA GLADES - New Hampshire
            { id: 49, name: "The Pike Glades", state: "NH", region: "Pike", lat: 44.0500, lon: -71.9500, elevation: 2200, vertical: 1500, maxPitch: 30, difficulty: "difficult", source: ["gba"], address: "2719 Mt Moosilauke Highway, Pike, NH" },
            { id: 50, name: "Maple Villa Glade", state: "NH", region: "Intervale", lat: 44.0833, lon: -71.1167, elevation: 2200, vertical: 1700, maxPitch: 32, difficulty: "difficult", source: ["gba"], address: "70 East Branch Road, Intervale, NH" },
            { id: 51, name: "West Side Glade", state: "NH", region: "Bartlett", lat: 44.0667, lon: -71.3000, elevation: 1600, vertical: 600, maxPitch: 25, difficulty: "moderate", source: ["gba"], address: "629 West Side Road, Bartlett, NH" },
            { id: 52, name: "Ski Tow Glade", state: "NH", region: "Lancaster", lat: 44.4833, lon: -71.5667, elevation: 2000, vertical: 700, maxPitch: 25, difficulty: "moderate", source: ["gba"], address: "Route 3, Prospect Street, Lancaster, NH" },
            { id: 53, name: "PRKR MTN Glades", state: "NH", region: "Littleton", lat: 44.3000, lon: -71.7667, elevation: 1800, vertical: 400, maxPitch: 22, difficulty: "easy", source: ["gba"], address: "Scout Lot, Littleton, NH" },
            { id: 54, name: "Baldface", state: "NH", region: "Chatham", lat: 44.2333, lon: -71.0000, elevation: 3000, vertical: 2500, maxPitch: 35, difficulty: "expert", source: ["gba"], address: "Baldface Circle Trail (Rt. 113), Chatham, NH" },
            { id: 55, name: "Cooley-Jericho Glade", state: "NH", region: "Franconia", lat: 44.2167, lon: -71.7500, elevation: 2600, vertical: 800, maxPitch: 28, difficulty: "moderate", source: ["gba"], address: "12 Trumpet Round Rd, Easton, NH" },
            { id: 56, name: "Hypnosis Glade", state: "NH", region: "Madison", lat: 43.9000, lon: -71.1333, elevation: 1400, vertical: 400, maxPitch: 22, difficulty: "easy", source: ["gba"], address: "White Mountain Hypnosis Center, Madison, NH" },
            { id: 57, name: "Bill Hill Glade", state: "NH", region: "Gorham", lat: 44.3833, lon: -71.1833, elevation: 1800, vertical: 600, maxPitch: 25, difficulty: "moderate", source: ["gba"], address: "Bellevue Road, Gorham, NH" },
            { id: 58, name: "Page Hill", state: "NH", region: "Tamworth", lat: 43.8500, lon: -71.2667, elevation: 1350, vertical: 350, maxPitch: 20, difficulty: "easy", source: ["gba"], address: "388 Page Hill Rd, Tamworth, NH" },

            // GBA GLADES - Maine
            { id: 59, name: "Black & White Glade", state: "ME", region: "Rumford", lat: 44.5500, lon: -70.5500, elevation: 2214, vertical: 1400, maxPitch: 30, difficulty: "difficult", source: ["gba"], address: "East Andover Road at Black Mountain of Maine" },

            // GBA CCC TRAILS
            { id: 60, name: "Doublehead CCC Trail", state: "NH", region: "Jackson", lat: 44.1317, lon: -71.1103, elevation: 3053, vertical: 1573, maxPitch: 28, difficulty: "moderate", source: ["gba"], address: "Jackson, NH" },
            { id: 61, name: "Black Mountain CCC Trail", state: "NH", region: "Jackson", lat: 44.0667, lon: -71.1500, elevation: 2747, vertical: 1527, maxPitch: 28, difficulty: "moderate", source: ["gba"], address: "Jackson, NH" },
            { id: 62, name: "John Sherburne Ski Trail", state: "NH", region: "Pinkham Notch", lat: 44.2572, lon: -71.2533, elevation: 3950, vertical: 1918, maxPitch: 32, difficulty: "difficult", source: ["gba"], address: "Pinkham Notch, NH" },
            { id: 63, name: "Gulf of Slides Ski Trail", state: "NH", region: "Pinkham Notch", lat: 44.2567, lon: -71.2553, elevation: 3900, vertical: 1868, maxPitch: 38, difficulty: "expert", source: ["gba"], address: "Pinkham Notch, NH" }
        ];

        // ==================== STATE ====================
        const weatherCache = new Map();
        const snowDepthCache = new Map();
        const tourWeatherData = new Map();
        const CACHE_DURATION = 15 * 60 * 1000;
        let favorites = JSON.parse(localStorage.getItem('backcountry-favorites') || '[]');
        let showFavoritesOnly = false;
        let currentTheme = localStorage.getItem('backcountry-theme') || 'dark';
        let map = null;
        let mapMarkers = [];
        let currentView = 'card';
        let mapMetric = 'snow-tomorrow';

        // ==================== WEATHER API ====================
        const MODEL_SUFFIXES = ['_gfs_seamless', '_ecmwf_ifs025', '_gem_seamless'];
        const SNOW_FIELDS = ['snowfall', 'snow_depth', 'snowfall_sum'];

        function mergeMultiModel(raw) {
            const merged = { hourly: { time: raw.hourly.time }, daily: { time: raw.daily.time } };

            // Collect all base field names from the hourly/daily keys
            function getBaseFields(section) {
                const bases = new Set();
                for (const key of Object.keys(raw[section])) {
                    if (key === 'time') continue;
                    for (const suffix of MODEL_SUFFIXES) {
                        if (key.endsWith(suffix)) {
                            bases.add(key.slice(0, -suffix.length));
                            break;
                        }
                    }
                }
                return bases;
            }

            function mergeSection(section) {
                const bases = getBaseFields(section);
                for (const base of bases) {
                    const isSnow = SNOW_FIELDS.includes(base);
                    const len = raw[section].time.length;
                    const result = new Array(len);

                    for (let i = 0; i < len; i++) {
                        const vals = [];
                        for (const suffix of MODEL_SUFFIXES) {
                            const arr = raw[section][base + suffix];
                            if (arr && arr[i] != null) vals.push(arr[i]);
                        }
                        if (vals.length === 0) {
                            result[i] = 0;
                        } else if (isSnow) {
                            result[i] = Math.max(...vals);
                        } else {
                            // Use GFS as primary, fall back to first available
                            const gfs = raw[section][base + '_gfs_seamless'];
                            result[i] = (gfs && gfs[i] != null) ? gfs[i] : vals[0];
                        }
                    }
                    merged[section][base] = result;
                }
            }

            mergeSection('hourly');
            mergeSection('daily');
            return merged;
        }

        async function fetchWeather(lat, lon, elevation) {
            const cacheKey = `${lat.toFixed(2)},${lon.toFixed(2)}`;
            const cached = weatherCache.get(cacheKey);

            if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
                return cached.data;
            }

            try {
                const elevMeters = elevation ? Math.round(elevation * 0.3048) : '';
                const elevParam = elevMeters ? `&elevation=${elevMeters}` : '';
                const models = '&models=gfs_seamless,ecmwf_ifs025,gem_seamless';
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}${elevParam}&hourly=temperature_2m,relative_humidity_2m,precipitation,rain,snowfall,snow_depth,visibility,windspeed_10m,windgusts_10m,weathercode&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_sum,rain_sum,snowfall_sum,windspeed_10m_max,windgusts_10m_max&timezone=America/New_York&forecast_days=10${models}`;
                const response = await fetch(url);
                const raw = await response.json();
                const data = mergeMultiModel(raw);

                weatherCache.set(cacheKey, { data, timestamp: Date.now() });
                return data;
            } catch (error) {
                console.error('Weather fetch error:', error);
                return null;
            }
        }

        async function fetchSnowDepthNOHRSC(lat, lon) {
            const cacheKey = `nohrsc_${lat.toFixed(2)},${lon.toFixed(2)}`;
            const cached = snowDepthCache.get(cacheKey);
            if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
                return cached.data;
            }

            try {
                const url = `https://mapservices.weather.noaa.gov/raster/rest/services/snow/NOHRSC_Snow_Analysis/MapServer/identify?geometry=${lon},${lat}&geometryType=esriGeometryPoint&sr=4326&layers=all:0&tolerance=1&mapExtent=${lon-1},${lat-1},${lon+1},${lat+1}&imageDisplay=400,400,96&returnGeometry=false&f=json`;
                const response = await fetch(url);
                const data = await response.json();

                const imageResult = data.results && data.results.find(r => r.layerName === 'Image');
                if (imageResult && imageResult.attributes) {
                    const pixelValue = parseFloat(imageResult.attributes['Service Pixel Value']);
                    if (!isNaN(pixelValue) && pixelValue >= 0) {
                        const result = { snowDepth: Math.round(pixelValue * 39.37) };
                        snowDepthCache.set(cacheKey, { data: result, timestamp: Date.now() });
                        return result;
                    }
                }

                snowDepthCache.set(cacheKey, { data: null, timestamp: Date.now() });
                return null;
            } catch (error) {
                console.error('NOHRSC snow depth error:', error);
                return null;
            }
        }

        function processWeatherData(weather, nohrscData) {
            if (!weather || !weather.hourly) return null;

            const { hourly, daily } = weather;
            const now = new Date();

            let currentIndex = 0;
            for (let i = 0; i < hourly.time.length; i++) {
                if (new Date(hourly.time[i]) > now) {
                    currentIndex = Math.max(0, i - 1);
                    break;
                }
            }

            // Snow depth: prefer NOHRSC observation, fall back to Open-Meteo model
            const modelSnowDepth = Math.round((hourly.snow_depth[currentIndex] || 0) * 39.37);
            const snowDepthValue = nohrscData ? nohrscData.snowDepth : modelSnowDepth;

            // Current conditions
            const current = {
                temp: Math.round(hourly.temperature_2m[currentIndex] * 9/5 + 32),
                humidity: hourly.relative_humidity_2m[currentIndex],
                snowDepth: snowDepthValue,
                snowDepthSource: nohrscData ? 'nohrsc' : 'model',
                wind: Math.round(hourly.windspeed_10m[currentIndex] * 0.621),
                gusts: Math.round((hourly.windgusts_10m[currentIndex] || 0) * 0.621),
                visibility: Math.round((hourly.visibility[currentIndex] || 10000) / 1609.34),
                weatherCode: hourly.weathercode[currentIndex]
            };

            // 24h totals
            let snow24h = 0, rain24h = 0;
            for (let i = currentIndex; i < Math.min(currentIndex + 24, hourly.snowfall.length); i++) {
                snow24h += hourly.snowfall[i] || 0;
                rain24h += hourly.rain[i] || 0;
            }

            // 7-day totals
            let snow10d = 0;
            if (daily && daily.snowfall_sum) {
                daily.snowfall_sum.forEach(s => snow10d += s || 0);
            }

            // Hourly forecast (next 24 hours for summary)
            const hourlyForecast = [];
            for (let i = currentIndex; i < Math.min(currentIndex + 24, hourly.time.length); i += 2) {
                hourlyForecast.push({
                    time: new Date(hourly.time[i]),
                    temp: Math.round(hourly.temperature_2m[i] * 9/5 + 32),
                    snow: Math.round((hourly.snowfall[i] || 0) / 2.54 * 10) / 10,
                    rain: Math.round((hourly.rain[i] || 0) / 25.4 * 10) / 10,
                    wind: Math.round(hourly.windspeed_10m[i] * 0.621),
                    code: hourly.weathercode[i]
                });
            }

            // Full hourly data (all hours, grouped by day for expandable view)
            const allHourly = [];
            for (let i = 0; i < hourly.time.length; i++) {
                allHourly.push({
                    time: new Date(hourly.time[i]),
                    temp: Math.round(hourly.temperature_2m[i] * 9/5 + 32),
                    snow: Math.round((hourly.snowfall[i] || 0) / 2.54 * 10) / 10,
                    rain: Math.round((hourly.rain[i] || 0) / 25.4 * 10) / 10,
                    wind: Math.round(hourly.windspeed_10m[i] * 0.621),
                    code: hourly.weathercode[i]
                });
            }

            // Daily forecast
            const dailyForecast = [];
            if (daily && daily.time) {
                for (let i = 0; i < daily.time.length; i++) {
                    dailyForecast.push({
                        date: new Date(daily.time[i] + 'T12:00:00'),
                        tempMax: Math.round(daily.temperature_2m_max[i] * 9/5 + 32),
                        tempMin: Math.round(daily.temperature_2m_min[i] * 9/5 + 32),
                        snow: Math.round((daily.snowfall_sum[i] || 0) / 2.54 * 10) / 10,
                        rain: Math.round((daily.rain_sum[i] || 0) / 25.4 * 10) / 10,
                        wind: Math.round(daily.windspeed_10m_max[i] * 0.621),
                        code: daily.weathercode[i]
                    });
                }
            }

            return {
                current,
                snow24h: Math.round(snow24h / 2.54 * 10) / 10,
                rain24h: Math.round(rain24h / 25.4 * 10) / 10,
                snow10d: Math.round(snow10d / 2.54 * 10) / 10,
                hourlyForecast,
                dailyForecast,
                allHourly
            };
        }

        function getWeatherIcon(code, size = 20) {
            const s = size;
            const icons = {
                clear: `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`,
                cloud: `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>`,
                partcloud: `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M12 2v2M4.93 4.93l1.41 1.41M20 12h2M17.66 17.66l1.41 1.41M2 12h2M6.34 17.66l-1.41 1.41M17.07 4.93l1.41-1.41"/><circle cx="12" cy="10" r="4"/><path d="M16 16h2a4 4 0 0 0 0-8h-.5A6 6 0 0 0 7 12.5 4 4 0 0 0 8 20h8"/></svg>`,
                fog: `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><line x1="3" y1="8" x2="21" y2="8"/><line x1="5" y1="12" x2="19" y2="12"/><line x1="3" y1="16" x2="21" y2="16"/></svg>`,
                rain: `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M16 13V4a4 4 0 0 0-8 0v1H6a4 4 0 0 0 0 8h10a3 3 0 0 0 0-6z"/><line x1="8" y1="19" x2="8" y2="21"/><line x1="12" y1="17" x2="12" y2="19"/><line x1="16" y1="19" x2="16" y2="21"/></svg>`,
                snow: `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><line x1="12" y1="2" x2="12" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/><line x1="19.07" y1="4.93" x2="4.93" y2="19.07"/></svg>`,
                thunder: `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"/><polyline points="13 11 9 17 15 17 11 23"/></svg>`
            };
            if (code === 0) return icons.clear;
            if (code === 1) return icons.partcloud;
            if (code === 2 || code === 3) return icons.cloud;
            if (code === 45 || code === 48) return icons.fog;
            if ((code >= 51 && code <= 67) || (code >= 80 && code <= 82)) return icons.rain;
            if ((code >= 71 && code <= 77) || code === 85 || code === 86) return icons.snow;
            if (code >= 95) return icons.thunder;
            return icons.clear;
        }

        // ==================== UI RENDERING ====================
        function buildForecastSparkline(dailyForecast) {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const n = dailyForecast.length;
            if (n === 0) return '';

            const marginL = 22, marginR = 22;
            const w = 320, h = 68, topPad = 10, bot = 2;
            const chartL = marginL, chartR = w - marginR;
            const chartW = chartR - chartL;
            const chartH = h - topPad - bot;
            const step = chartW / (n - 1);

            // Compute ranges
            const maxPrecip = Math.max(...dailyForecast.map(d => Math.max(d.snow, d.rain)), 0.3);
            const temps = dailyForecast.map(d => (d.tempMax + d.tempMin) / 2);
            const minTemp = Math.min(...temps) - 2;
            const maxTemp = Math.max(...temps) + 2;
            const maxWind = Math.max(...dailyForecast.map(d => d.wind), 5);

            function precipY(v) { return topPad + chartH - (v / maxPrecip) * chartH; }
            function tempY(v) { return topPad + chartH - ((v - minTemp) / (maxTemp - minTemp)) * chartH; }
            function windY(v) { return topPad + chartH - (v / maxWind) * chartH * 0.7; }
            function px(i) { return chartL + i * step; }

            // Build line paths
            let snowPts = '', rainPts = '', tempPts = '', windPts = '';
            for (let i = 0; i < n; i++) {
                const x = px(i);
                snowPts += `${i === 0 ? 'M' : 'L'}${x},${precipY(dailyForecast[i].snow)} `;
                rainPts += `${i === 0 ? 'M' : 'L'}${x},${precipY(dailyForecast[i].rain)} `;
                tempPts += `${i === 0 ? 'M' : 'L'}${x},${tempY(temps[i])} `;
                windPts += `${i === 0 ? 'M' : 'L'}${x},${windY(dailyForecast[i].wind)} `;
            }

            const snowFill = `${snowPts}L${px(n-1)},${precipY(0)} L${px(0)},${precipY(0)} Z`;
            const hasRain = dailyForecast.some(d => d.rain > 0);

            let svg = '';

            // ── Day labels ──
            for (let i = 0; i < n; i++) {
                const dayName = i === 0 ? 'Tdy' : days[dailyForecast[i].date.getDay()];
                svg += `<text x="${px(i)}" y="${topPad - 2}" text-anchor="middle" font-size="5.5" font-family="var(--font)" font-weight="500" fill="var(--text-muted)">${dayName}</text>`;
            }

            // ── Left Y-axis: Temp (°F) ──
            const tempTicks = 3;
            for (let t = 0; t < tempTicks; t++) {
                const val = Math.round(minTemp + (maxTemp - minTemp) * (t / (tempTicks - 1)));
                const y = tempY(val);
                svg += `<text x="${marginL - 3}" y="${y + 2}" text-anchor="end" font-size="5" font-family="var(--mono)" fill="var(--accent-red)" opacity="0.45">${val}°</text>`;
            }

            // ── Right Y-axis: Wind (mph) ──
            const windTicks = 3;
            for (let t = 0; t < windTicks; t++) {
                const val = Math.round(maxWind * (t / (windTicks - 1)));
                const y = windY(val);
                svg += `<text x="${chartR + 3}" y="${y + 2}" text-anchor="start" font-size="5" font-family="var(--mono)" fill="var(--accent-yellow)" opacity="0.4">${val}</text>`;
            }

            // ── Freezing line (32°F) ──
            if (maxTemp > 32 && minTemp < 32) {
                const fY = tempY(32);
                svg += `<line x1="${chartL}" y1="${fY}" x2="${chartR}" y2="${fY}" stroke="var(--text-muted)" stroke-width="0.3" stroke-dasharray="2,3" opacity="0.3"/>`;
                svg += `<text x="${marginL - 3}" y="${fY + 2}" text-anchor="end" font-size="4.5" font-family="var(--mono)" fill="var(--text-muted)" opacity="0.5">32°</text>`;
            }

            // ── Snow fill + line ──
            svg += `<path d="${snowFill}" fill="var(--accent-blue)" opacity="0.12"/>`;
            svg += `<path d="${snowPts}" fill="none" stroke="var(--accent-blue)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>`;

            // ── Rain line ──
            if (hasRain) {
                svg += `<path d="${rainPts}" fill="none" stroke="var(--accent-rain)" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" opacity="0.7"/>`;
            }

            // ── Temp line ──
            svg += `<path d="${tempPts}" fill="none" stroke="var(--accent-red)" stroke-width="0.8" stroke-linecap="round" stroke-linejoin="round" opacity="0.45"/>`;

            // ── Wind line ──
            svg += `<path d="${windPts}" fill="none" stroke="var(--accent-yellow)" stroke-width="0.6" stroke-dasharray="2,2" stroke-linecap="round" opacity="0.35"/>`;

            // ── Snow dots + labels ──
            for (let i = 0; i < n; i++) {
                const x = px(i);
                if (dailyForecast[i].snow > 0) {
                    const y = precipY(dailyForecast[i].snow);
                    svg += `<circle cx="${x}" cy="${y}" r="2" fill="var(--accent-blue)"/>`;
                    svg += `<text x="${x}" y="${y - 4}" text-anchor="middle" font-size="6.5" font-family="var(--mono)" font-weight="600" fill="var(--accent-blue)">${dailyForecast[i].snow}"</text>`;
                }
            }

            return `<div class="forecast-chart"><svg width="100%" viewBox="0 0 ${w} ${h}" preserveAspectRatio="xMidYMid meet">${svg}</svg></div>`;
        }

        function buildHourlyChart(hourlyForecast) {
            const n = hourlyForecast.length;
            if (n === 0) return '';

            const marginL = 28, marginR = 28;
            const w = 500, h = 140, topPad = 14, bot = 16;
            const chartL = marginL, chartR = w - marginR;
            const chartW = chartR - chartL;
            const chartH = h - topPad - bot;
            const step = chartW / (n - 1);

            const maxPrecip = Math.max(...hourlyForecast.map(d => Math.max(d.snow, d.rain)), 0.2);
            const minTemp = Math.min(...hourlyForecast.map(d => d.temp)) - 2;
            const maxTemp = Math.max(...hourlyForecast.map(d => d.temp)) + 2;
            const maxWind = Math.max(...hourlyForecast.map(d => d.wind), 3);

            function precipY(v) { return topPad + chartH - (v / maxPrecip) * chartH; }
            function tempY(v) { return topPad + chartH - ((v - minTemp) / (maxTemp - minTemp)) * chartH; }
            function windY(v) { return topPad + chartH - (v / maxWind) * chartH * 0.7; }
            function px(i) { return chartL + i * step; }

            let snowPts = '', rainPts = '', tempPts = '', windPts = '';
            for (let i = 0; i < n; i++) {
                const x = px(i);
                snowPts += `${i === 0 ? 'M' : 'L'}${x},${precipY(hourlyForecast[i].snow)} `;
                rainPts += `${i === 0 ? 'M' : 'L'}${x},${precipY(hourlyForecast[i].rain)} `;
                tempPts += `${i === 0 ? 'M' : 'L'}${x},${tempY(hourlyForecast[i].temp)} `;
                windPts += `${i === 0 ? 'M' : 'L'}${x},${windY(hourlyForecast[i].wind)} `;
            }

            const snowFill = `${snowPts}L${px(n-1)},${precipY(0)} L${px(0)},${precipY(0)} Z`;
            const hasRain = hourlyForecast.some(d => d.rain > 0);

            let svg = '';

            // Hour labels along bottom
            for (let i = 0; i < n; i++) {
                const timeStr = hourlyForecast[i].time.toLocaleTimeString('en-US', { hour: 'numeric' });
                svg += `<text x="${px(i)}" y="${h - 2}" text-anchor="middle" font-size="7" font-family="var(--font)" font-weight="500" fill="var(--text-muted)">${timeStr}</text>`;
            }

            // Left Y-axis: Temp
            const tempTicks = 4;
            for (let t = 0; t < tempTicks; t++) {
                const val = Math.round(minTemp + (maxTemp - minTemp) * (t / (tempTicks - 1)));
                const y = tempY(val);
                svg += `<line x1="${chartL}" y1="${y}" x2="${chartR}" y2="${y}" stroke="var(--text-muted)" stroke-width="0.2" opacity="0.2"/>`;
                svg += `<text x="${marginL - 3}" y="${y + 2.5}" text-anchor="end" font-size="6.5" font-family="var(--mono)" fill="var(--accent-red)" opacity="0.5">${val}°</text>`;
            }

            // Right Y-axis: Wind
            const windTicks = 3;
            for (let t = 0; t < windTicks; t++) {
                const val = Math.round(maxWind * (t / (windTicks - 1)));
                const y = windY(val);
                svg += `<text x="${chartR + 3}" y="${y + 2.5}" text-anchor="start" font-size="6.5" font-family="var(--mono)" fill="var(--accent-yellow)" opacity="0.45">${val}</text>`;
            }

            // Freezing line
            if (maxTemp > 32 && minTemp < 32) {
                const fY = tempY(32);
                svg += `<line x1="${chartL}" y1="${fY}" x2="${chartR}" y2="${fY}" stroke="var(--text-muted)" stroke-width="0.4" stroke-dasharray="3,4" opacity="0.3"/>`;
                svg += `<text x="${marginL - 3}" y="${fY + 2.5}" text-anchor="end" font-size="5.5" font-family="var(--mono)" fill="var(--text-muted)" opacity="0.5">32°</text>`;
            }

            // Snow fill + line
            svg += `<path d="${snowFill}" fill="var(--accent-blue)" opacity="0.15"/>`;
            svg += `<path d="${snowPts}" fill="none" stroke="var(--accent-blue)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;

            // Rain line
            if (hasRain) {
                svg += `<path d="${rainPts}" fill="none" stroke="var(--accent-rain)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.7"/>`;
            }

            // Temp line
            svg += `<path d="${tempPts}" fill="none" stroke="var(--accent-red)" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" opacity="0.5"/>`;

            // Wind line
            svg += `<path d="${windPts}" fill="none" stroke="var(--accent-yellow)" stroke-width="0.8" stroke-dasharray="3,3" stroke-linecap="round" opacity="0.4"/>`;

            // Snow dots + labels
            for (let i = 0; i < n; i++) {
                if (hourlyForecast[i].snow > 0) {
                    const x = px(i), y = precipY(hourlyForecast[i].snow);
                    svg += `<circle cx="${x}" cy="${y}" r="2.5" fill="var(--accent-blue)"/>`;
                    svg += `<text x="${x}" y="${y - 5}" text-anchor="middle" font-size="7.5" font-family="var(--mono)" font-weight="600" fill="var(--accent-blue)">${hourlyForecast[i].snow}"</text>`;
                }
            }

            // Temp value dots
            for (let i = 0; i < n; i++) {
                const x = px(i), y = tempY(hourlyForecast[i].temp);
                svg += `<circle cx="${x}" cy="${y}" r="1.5" fill="var(--accent-red)" opacity="0.5"/>`;
            }

            // Hover cursor line (hidden by default)
            svg += `<line class="hc-cursor" x1="0" y1="${topPad}" x2="0" y2="${h - bot}" stroke="var(--text-muted)" stroke-width="0.5" opacity="0" stroke-dasharray="2,2"/>`;

            // Serialize data points for hover lookup
            const hoverData = hourlyForecast.map((hr, i) => ({
                x: px(i),
                time: hr.time.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                temp: hr.temp,
                snow: hr.snow,
                rain: hr.rain,
                wind: hr.wind
            }));
            const dataAttr = JSON.stringify(hoverData).replace(/"/g, '&quot;');

            return `<div class="hourly-chart" data-hover='${dataAttr}' data-vw="${w}" data-cl="${chartL}" data-cr="${chartR}"><svg width="100%" viewBox="0 0 ${w} ${h}" preserveAspectRatio="xMidYMid meet">${svg}</svg><div class="hc-tooltip"></div></div>`;
        }

        function renderTourCard(tour) {
            const weather = tourWeatherData.get(tour.id);
            const isFavorite = favorites.includes(tour.id);

            const card = document.createElement('div');
            card.className = 'tour-card';
            card.dataset.id = tour.id;
            card.dataset.state = tour.state.toLowerCase();
            card.dataset.source = tour.source.join(',');
            card.dataset.name = tour.name.toLowerCase();
            card.dataset.elevation = tour.elevation;
            card.dataset.snowDepth = weather?.current?.snowDepth || 0;
            card.dataset.forecast = weather?.snow10d || 0;

            let weatherHtml = '<div class="weather-grid"><p class="loading">Loading weather...</p></div>';
            let forecastHtml = '';

            if (weather) {
                const sourceLabel = weather.current.snowDepthSource === 'nohrsc'
                    ? '<div class="weather-label" style="margin-top:2px;font-size:0.55rem;opacity:0.7;">NOAA obs.</div>'
                    : '';
                weatherHtml = `
                    <div class="weather-grid">
                        <div class="weather-item">
                            <div class="weather-label">Snow Depth</div>
                            <div class="weather-value depth">${weather.current.snowDepth}"</div>
                            ${sourceLabel}
                        </div>
                        <div class="weather-item">
                            <div class="weather-label">24h Precip <span class="precip-legend"><span class="pl-snow">&#10052;</span><span class="precip-gradient-line"></span><span class="pl-rain">&#9679;</span></span></div>
                            <div class="weather-value snow">${weather.snow24h}"</div>
                        </div>
                        <div class="weather-item">
                            <div class="weather-label">Temp <span class="legend-indicator temp-line"></span></div>
                            <div class="weather-value temp">${weather.current.temp}°F</div>
                        </div>
                        <div class="weather-item">
                            <div class="weather-label">Wind <span class="legend-indicator wind-line"></span></div>
                            <div class="weather-value wind">${weather.current.wind} mph</div>
                        </div>
                    </div>
                `;

                if (weather.dailyForecast.length > 0) {
                    forecastHtml = buildForecastSparkline(weather.dailyForecast);
                }
            }

            const badges = [];
            const sourceLabels = { book: 'Book', gba: 'GBA', ikon: 'Ikon', epic: 'Epic', indy: 'Indy' };
            tour.source.forEach(s => {
                badges.push(`<span class="tour-badge ${s}">${sourceLabels[s] || s}</span>`);
            });
            if (tour.difficulty) {
                const diffLabels = { easy: 'Easy', moderate: 'Moderate', difficult: 'Difficult', expert: 'Expert', extreme: 'Extreme' };
                badges.push(`<span class="tour-badge difficulty-${tour.difficulty}">${diffLabels[tour.difficulty]}</span>`);
            }
            badges.push(`<span class="tour-badge elevation">${tour.elevation.toLocaleString()} ft</span>`);
            if (tour.vertical) {
                badges.push(`<span class="tour-badge vertical">${tour.vertical.toLocaleString()} ft vert</span>`);
            }
            if (tour.maxPitch) {
                badges.push(`<span class="tour-badge pitch">${tour.maxPitch}°</span>`);
            }

            card.innerHTML = `
                <button class="favorite-btn ${isFavorite ? 'favorited' : ''}" onclick="toggleFavorite(event, ${tour.id})">
                    ${isFavorite ? '&#9733;' : '&#9734;'}
                </button>
                <div class="tour-header">
                    <div class="tour-name">${tour.name}</div>
                    <div class="tour-location">${tour.region}, ${tour.state}</div>
                    <div class="tour-meta">${badges.join('')}</div>
                </div>
                ${weatherHtml}
                ${forecastHtml}
                <div class="click-hint">Click for detailed forecast</div>
            `;

            card.addEventListener('click', (e) => {
                if (!e.target.classList.contains('favorite-btn')) {
                    openModal(tour);
                }
            });

            return card;
        }

        async function renderTours() {
            const container = document.getElementById('tours-container');
            container.innerHTML = '';

            const stateGroups = {};
            tours.forEach(tour => {
                if (!stateGroups[tour.state]) stateGroups[tour.state] = [];
                stateGroups[tour.state].push(tour);
            });

            const stateNames = {
                'NH': 'New Hampshire', 'VT': 'Vermont', 'ME': 'Maine',
                'NY': 'New York', 'MA': 'Massachusetts', 'PA': 'Pennsylvania'
            };

            for (const state of ['NH', 'VT', 'ME', 'NY', 'MA', 'PA']) {
                if (!stateGroups[state]) continue;

                const section = document.createElement('div');
                section.className = 'state-section';
                section.dataset.state = state.toLowerCase();

                const title = document.createElement('h2');
                title.className = 'section-title';
                title.innerHTML = `${stateNames[state]} <span style="font-size: 0.9rem; color: var(--text-muted);">(${stateGroups[state].length})</span>`;
                section.appendChild(title);

                const grid = document.createElement('div');
                grid.className = 'tours-grid';

                for (const tour of stateGroups[state]) {
                    const card = renderTourCard(tour);
                    grid.appendChild(card);

                    // Fetch weather + NOHRSC snow depth async
                    Promise.all([
                        fetchWeather(tour.lat, tour.lon, tour.elevation),
                        fetchSnowDepthNOHRSC(tour.lat, tour.lon)
                    ]).then(([weather, nohrscData]) => {
                        const processed = processWeatherData(weather, nohrscData);
                        if (processed) {
                            tourWeatherData.set(tour.id, processed);
                            const newCard = renderTourCard(tour);
                            card.replaceWith(newCard);
                            updateStats();
                            if (currentView === 'map') updateMapMarkers();
                        }
                    });
                }

                section.appendChild(grid);
                container.appendChild(section);
            }

            document.getElementById('update-time').textContent = new Date().toLocaleString();
            document.getElementById('total-tours').textContent = tours.length;
            updateFavoritesCount();
        }

        // ==================== MODAL ====================
        function openModal(tour) {
            const weather = tourWeatherData.get(tour.id);
            const modal = document.getElementById('modal-overlay');

            document.getElementById('modal-title').textContent = tour.name;
            document.getElementById('modal-subtitle').textContent = `${tour.region}, ${tour.state} · ${tour.elevation.toLocaleString()} ft elevation`;

            let bodyHtml = '';

            if (!weather) {
                bodyHtml = '<div class="loading">Loading weather data...</div>';
            } else {
                // Current Conditions
                bodyHtml += `
                    <div class="modal-section">
                        <h3 class="modal-section-title">Current Conditions</h3>
                        <div class="current-conditions">
                            <div class="condition-card">
                                <div class="condition-icon" style="color:var(--text-muted)">${getWeatherIcon(weather.current.weatherCode, 22)}</div>
                                <div class="condition-value" style="color: var(--accent-purple);">${weather.current.snowDepth}"</div>
                                <div class="condition-label">Snow Depth</div>
                                ${weather.current.snowDepthSource === 'nohrsc'
                                    ? '<div style="font-size:0.6rem;color:var(--text-muted);margin-top:3px;">NOAA</div>'
                                    : ''}
                            </div>
                            <div class="condition-card">
                                <div class="condition-icon" style="color:var(--accent-blue)">${getWeatherIcon(71, 22)}</div>
                                <div class="condition-value" style="color: var(--accent-blue);">${weather.snow24h}"</div>
                                <div class="condition-label">24h Snowfall</div>
                            </div>
                            <div class="condition-card">
                                <div class="condition-icon" style="color:var(--accent-red)">${getWeatherIcon(0, 22)}</div>
                                <div class="condition-value" style="color: var(--accent-red);">${weather.current.temp}°F</div>
                                <div class="condition-label">Temperature</div>
                            </div>
                            <div class="condition-card">
                                <div class="condition-icon" style="color:var(--accent-yellow)"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg></div>
                                <div class="condition-value" style="color: var(--accent-yellow);">${weather.current.wind}</div>
                                <div class="condition-label">Wind (mph)</div>
                            </div>
                            <div class="condition-card">
                                <div class="condition-icon" style="color:var(--accent-rain)">${getWeatherIcon(61, 22)}</div>
                                <div class="condition-value" style="color: var(--accent-rain);">${weather.rain24h}"</div>
                                <div class="condition-label">24h Rain</div>
                            </div>
                            <div class="condition-card">
                                <div class="condition-icon" style="color:var(--text-muted)"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg></div>
                                <div class="condition-value">${weather.current.humidity}%</div>
                                <div class="condition-label">Humidity</div>
                            </div>
                            <div class="condition-card">
                                <div class="condition-icon" style="color:var(--text-muted)"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg></div>
                                <div class="condition-value">${weather.current.visibility}</div>
                                <div class="condition-label">Visibility (mi)</div>
                            </div>
                            <div class="condition-card">
                                <div class="condition-icon" style="color:var(--text-muted)"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg></div>
                                <div class="condition-value">${weather.current.gusts}</div>
                                <div class="condition-label">Gusts (mph)</div>
                            </div>
                        </div>
                    </div>
                `;

                // Hourly Forecast Chart
                if (weather.hourlyForecast.length > 0) {
                    bodyHtml += `
                        <div class="modal-section">
                            <h3 class="modal-section-title">Hourly Forecast (Next 24h)</h3>
                            <div class="hourly-chart-legend">
                                <span class="hcl-item"><span class="pl-snow">&#10052;</span> Snow <span class="precip-gradient-line"></span> Rain <span class="pl-rain">&#9679;</span></span>
                                <span class="hcl-item"><span class="legend-indicator temp-line"></span> Temp</span>
                                <span class="hcl-item"><span class="legend-indicator wind-line"></span> Wind</span>
                            </div>
                            ${buildHourlyChart(weather.hourlyForecast)}
                        </div>
                    `;
                }

                // 10-Day Forecast with expandable hourly
                if (weather.dailyForecast.length > 0) {
                    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    const maxSnow = Math.max(...weather.dailyForecast.map(d => d.snow), 0.1);

                    bodyHtml += `
                        <div class="modal-section">
                            <h3 class="modal-section-title">10-Day Forecast — ${weather.snow10d}" total snow</h3>
                            <table class="forecast-table">
                                <thead>
                                    <tr>
                                        <th>Day</th>
                                        <th></th>
                                        <th>Snow</th>
                                        <th>Rain</th>
                                        <th>Hi / Lo</th>
                                        <th>Wind</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    weather.dailyForecast.forEach((day, i) => {
                        const dayName = i === 0 ? 'Today' : days[day.date.getDay()];
                        const dateStr = day.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const barW = Math.round((day.snow / maxSnow) * 40);

                        // Get hourly data for this day
                        const dayStart = new Date(day.date);
                        dayStart.setHours(0, 0, 0, 0);
                        const dayEnd = new Date(dayStart);
                        dayEnd.setDate(dayEnd.getDate() + 1);
                        const dayHours = weather.allHourly.filter(h => h.time >= dayStart && h.time < dayEnd);

                        bodyHtml += `
                            <tr class="day-row" data-day-index="${i}" onclick="document.querySelectorAll('.hourly-tr-${i}').forEach(r=>r.classList.toggle('show'));this.classList.toggle('expanded');" style="cursor:pointer;">
                                <td>${dayName} <span style="color:var(--text-muted);font-size:0.72rem;">${dateStr}</span> <span class="expand-arrow">&#9656;</span></td>
                                <td style="color:var(--text-muted)">${getWeatherIcon(day.code, 16)}</td>
                                <td class="snow-val">${day.snow > 0 ? `<span class="snow-bar" style="width:${barW}px"></span>${day.snow}"` : '—'}</td>
                                <td class="rain-val">${day.rain > 0 ? day.rain + '"' : '—'}</td>
                                <td class="temp-val">${day.tempMax}°/${day.tempMin}°</td>
                                <td class="wind-val">${day.wind}</td>
                            </tr>
                        `;

                        if (dayHours.length > 0) {
                            dayHours.forEach(h => {
                                const timeStr = h.time.toLocaleTimeString('en-US', { hour: 'numeric' });
                                bodyHtml += `
                                    <tr class="hourly-detail-row hourly-tr-${i}">
                                        <td class="he-time">${timeStr}</td>
                                        <td style="color:var(--text-muted)">${getWeatherIcon(h.code, 14)}</td>
                                        <td class="snow-val">${h.snow > 0 ? h.snow + '"' : '—'}</td>
                                        <td class="rain-val">${h.rain > 0 ? h.rain + '"' : '—'}</td>
                                        <td class="temp-val">${h.temp}°</td>
                                        <td class="wind-val">${h.wind}</td>
                                    </tr>
                                `;
                            });
                        }
                    });
                    bodyHtml += '</tbody></table></div>';
                }
            }

            // Location & Map
            bodyHtml += `
                <div class="modal-section">
                    <h3 class="modal-section-title">Location</h3>
                    <div id="modal-map" class="modal-map" style="margin-bottom:14px;"></div>
                    <div class="location-info">
                        <div class="info-item">
                            <div class="info-label">Elevation</div>
                            <div class="info-value" style="font-family:var(--mono)">${tour.elevation.toLocaleString()} ft</div>
                        </div>
                        ${tour.vertical ? `
                        <div class="info-item">
                            <div class="info-label">Vertical</div>
                            <div class="info-value" style="font-family:var(--mono)">${tour.vertical.toLocaleString()} ft</div>
                        </div>` : ''}
                        ${tour.maxPitch ? `
                        <div class="info-item">
                            <div class="info-label">Max Pitch</div>
                            <div class="info-value" style="font-family:var(--mono)">${tour.maxPitch}°</div>
                        </div>` : ''}
                        ${tour.difficulty ? `
                        <div class="info-item">
                            <div class="info-label">Difficulty</div>
                            <div class="info-value"><span class="tour-badge difficulty-${tour.difficulty}" style="font-size:0.75rem;">${tour.difficulty.charAt(0).toUpperCase() + tour.difficulty.slice(1)}</span></div>
                        </div>` : ''}
                        <div class="info-item">
                            <div class="info-label">Coordinates</div>
                            <div class="info-value" style="font-family:var(--mono)">${tour.lat.toFixed(4)}, ${tour.lon.toFixed(4)}</div>
                        </div>
                        ${tour.address ? `
                        <div class="info-item">
                            <div class="info-label">Trailhead</div>
                            <div class="info-value">${tour.address}</div>
                        </div>` : ''}
                        <div class="info-item">
                            <div class="info-label">Source</div>
                            <div class="info-value">
                                ${tour.source.map(s => {
                                    if (s === 'gba') return '<a href="https://granitebackcountryalliance.org/" target="_blank">Granite Backcountry Alliance</a>';
                                    if (s === 'book') return '<a href="https://bestbackcountryskiing.com/" target="_blank">Best Backcountry Skiing in the Northeast</a>';
                                    if (s === 'ikon') return '<a href="https://www.ikonpass.com/" target="_blank">Ikon Pass</a>';
                                    if (s === 'epic') return '<a href="https://www.epicpass.com/" target="_blank">Epic Pass</a>';
                                    if (s === 'indy') return '<a href="https://www.indyskipass.com/" target="_blank">Indy Pass</a>';
                                    return s;
                                }).join(' &middot; ')}
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Directions</div>
                            <div class="info-value">
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${tour.lat},${tour.lon}" target="_blank">Open in Google Maps</a>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('modal-body').innerHTML = bodyHtml;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Initialize modal mini-map
            setTimeout(() => {
                const mapEl = document.getElementById('modal-map');
                if (mapEl && !mapEl._leaflet_id) {
                    const miniMap = L.map(mapEl, { zoomControl: false, attributionControl: false, dragging: false, scrollWheelZoom: false }).setView([tour.lat, tour.lon], 12);
                    L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17 }).addTo(miniMap);
                    L.marker([tour.lat, tour.lon]).addTo(miniMap);
                    mapEl._miniMap = miniMap;
                }
            }, 100);

            // Hourly chart hover
            const hcEl = document.querySelector('.hourly-chart[data-hover]');
            if (hcEl) {
                const points = JSON.parse(hcEl.dataset.hover);
                const vw = parseFloat(hcEl.dataset.vw);
                const cl = parseFloat(hcEl.dataset.cl);
                const cr = parseFloat(hcEl.dataset.cr);
                const tooltip = hcEl.querySelector('.hc-tooltip');
                const cursor = hcEl.querySelector('.hc-cursor');

                hcEl.addEventListener('mousemove', (e) => {
                    const rect = hcEl.getBoundingClientRect();
                    const relX = (e.clientX - rect.left) / rect.width * vw;

                    // Find nearest point
                    let closest = 0, minDist = Infinity;
                    for (let i = 0; i < points.length; i++) {
                        const d = Math.abs(points[i].x - relX);
                        if (d < minDist) { minDist = d; closest = i; }
                    }
                    const pt = points[closest];

                    // Update cursor line
                    cursor.setAttribute('x1', pt.x);
                    cursor.setAttribute('x2', pt.x);
                    cursor.setAttribute('opacity', '0.5');

                    // Update tooltip
                    let html = `<div class="tt-time">${pt.time}</div>`;
                    html += `<div class="tt-temp">Temp: ${pt.temp}°F</div>`;
                    if (pt.snow > 0) html += `<div class="tt-snow">Snow: ${pt.snow}"</div>`;
                    if (pt.rain > 0) html += `<div class="tt-rain">Rain: ${pt.rain}"</div>`;
                    html += `<div class="tt-wind">Wind: ${pt.wind} mph</div>`;
                    tooltip.innerHTML = html;
                    tooltip.classList.add('visible');

                    // Position tooltip
                    const pxPos = (pt.x / vw) * rect.width;
                    const tooltipW = tooltip.offsetWidth;
                    let left = pxPos - tooltipW / 2;
                    if (left < 4) left = 4;
                    if (left + tooltipW > rect.width - 4) left = rect.width - tooltipW - 4;
                    tooltip.style.left = left + 'px';
                });

                hcEl.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('visible');
                    cursor.setAttribute('opacity', '0');
                });
            }
        }

        function closeModal() {
            const mapEl = document.getElementById('modal-map');
            if (mapEl && mapEl._miniMap) {
                mapEl._miniMap.remove();
                mapEl._miniMap = null;
            }
            document.getElementById('modal-overlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        // ==================== FAVORITES ====================
        function toggleFavorite(event, id) {
            event.stopPropagation();
            const index = favorites.indexOf(id);
            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(id);
            }
            localStorage.setItem('backcountry-favorites', JSON.stringify(favorites));

            // Update button
            const btn = event.target;
            btn.classList.toggle('favorited');
            btn.innerHTML = favorites.includes(id) ? '&#9733;' : '&#9734;';

            updateFavoritesCount();
            if (showFavoritesOnly) applyFilters();
        }

        function updateFavoritesCount() {
            document.getElementById('favorites-count').textContent = favorites.length;
        }

        // ==================== FILTERING & SORTING ====================
        const stateFilters = ['nh', 'vt', 'me', 'ny', 'ma', 'pa'];

        function getActiveFilters() {
            const active = Array.from(document.querySelectorAll('.filter-btn.active')).map(b => b.dataset.filter);
            return active.includes('all') ? ['all'] : active;
        }

        function matchesFilters(activeFilters, cardState, cardSources) {
            if (activeFilters.includes('all')) return true;
            const stateActive = activeFilters.filter(f => stateFilters.includes(f));
            const sourceActive = activeFilters.filter(f => !stateFilters.includes(f));
            let stateMatch = stateActive.length === 0 || stateActive.includes(cardState);
            let sourceMatch = sourceActive.length === 0 || sourceActive.some(f => cardSources.includes(f));
            return stateMatch && sourceMatch;
        }

        function applyFilters() {
            const activeFilters = getActiveFilters();
            const searchTerm = document.getElementById('search-input').value.toLowerCase();

            document.querySelectorAll('.tour-card').forEach(card => {
                let show = true;
                const id = parseInt(card.dataset.id);

                if (showFavoritesOnly && !favorites.includes(id)) {
                    show = false;
                }

                if (show) {
                    const sources = card.dataset.source.split(',');
                    show = matchesFilters(activeFilters, card.dataset.state, sources);
                }

                if (show && searchTerm) {
                    show = card.dataset.name.includes(searchTerm);
                }

                card.style.display = show ? '' : 'none';
            });

            // Hide empty sections
            document.querySelectorAll('.state-section').forEach(section => {
                const hasVisible = Array.from(section.querySelectorAll('.tour-card')).some(c => c.style.display !== 'none');
                section.style.display = hasVisible ? '' : 'none';
            });

            applySorting();

            if (currentView === 'map') {
                updateMapMarkers();
            }
        }

        function applySorting() {
            const sortBy = document.getElementById('sort-select').value;

            document.querySelectorAll('.tours-grid').forEach(grid => {
                const cards = Array.from(grid.querySelectorAll('.tour-card'));

                cards.sort((a, b) => {
                    switch (sortBy) {
                        case 'snow-desc':
                            return parseFloat(b.dataset.snowDepth) - parseFloat(a.dataset.snowDepth);
                        case 'snow-asc':
                            return parseFloat(a.dataset.snowDepth) - parseFloat(b.dataset.snowDepth);
                        case 'elevation-desc':
                            return parseInt(b.dataset.elevation) - parseInt(a.dataset.elevation);
                        case 'elevation-asc':
                            return parseInt(a.dataset.elevation) - parseInt(b.dataset.elevation);
                        case 'forecast':
                            return parseFloat(b.dataset.forecast) - parseFloat(a.dataset.forecast);
                        default: // name
                            return a.dataset.name.localeCompare(b.dataset.name);
                    }
                });

                cards.forEach(card => grid.appendChild(card));
            });
        }

        // ==================== THEME ====================
        function setTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('backcountry-theme', theme);
            document.getElementById('theme-icon').innerHTML = theme === 'dark' ? '&#9788;' : '&#9790;';
        }

        // ==================== STATS ====================
        function updateStats() {
            let withSnow = 0;
            let bestDepth = 0;

            tourWeatherData.forEach(weather => {
                if (weather.current.snowDepth > 0) withSnow++;
                if (weather.current.snowDepth > bestDepth) bestDepth = weather.current.snowDepth;
            });

            document.getElementById('snow-tours').textContent = withSnow;
            document.getElementById('best-snow').textContent = bestDepth + '"';
        }

        // ==================== MAP ====================
        function initMap() {
            if (map) return;
            map = L.map('map').setView([44.0, -71.5], 7);
            L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                maxZoom: 17,
                attribution: '&copy; <a href="https://opentopomap.org">OpenTopoMap</a> contributors'
            }).addTo(map);
        }

        function updateMapMarkers() {
            if (!map) return;

            // Clear existing markers
            mapMarkers.forEach(m => map.removeLayer(m));
            mapMarkers = [];

            const activeFilters = getActiveFilters();
            const searchTerm = document.getElementById('search-input').value.toLowerCase();

            const visibleTours = tours.filter(tour => {
                if (showFavoritesOnly && !favorites.includes(tour.id)) return false;
                if (!matchesFilters(activeFilters, tour.state.toLowerCase(), tour.source)) return false;
                if (searchTerm && !tour.name.toLowerCase().includes(searchTerm)) return false;
                return true;
            });

            const bounds = [];

            visibleTours.forEach(tour => {
                const weather = tourWeatherData.get(tour.id);
                let label = '—';
                let colorClass = 'no-snow';

                if (weather) {
                    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    switch (mapMetric) {
                        case 'snow-tomorrow': {
                            const val = weather.dailyForecast?.[1]?.snow ?? null;
                            label = val !== null ? val + '"' : '—';
                            colorClass = (val !== null && val > 0) ? 'has-snow' : 'no-snow';
                            break;
                        }
                        case 'wind': {
                            const val = weather.current.wind;
                            label = val + ' mph';
                            colorClass = val > 20 ? 'has-wind' : 'no-snow';
                            break;
                        }
                        case 'temp': {
                            const val = weather.current.temp;
                            label = val + '°F';
                            colorClass = val > 32 ? 'hot' : 'cold';
                            break;
                        }
                        case 'best-day': {
                            const forecast = weather.dailyForecast.slice(0, 5);
                            let bestIdx = 0, bestSnow = 0;
                            forecast.forEach((d, i) => {
                                if (d.snow > bestSnow) { bestSnow = d.snow; bestIdx = i; }
                            });
                            if (bestSnow > 0) {
                                const dayName = days[forecast[bestIdx].date.getDay()];
                                label = dayName + ' ' + bestSnow + '"';
                                colorClass = 'has-snow';
                            } else {
                                label = '—';
                                colorClass = 'no-snow';
                            }
                            break;
                        }
                    }
                }

                const icon = L.divIcon({
                    className: 'snow-marker',
                    html: `<div class="snow-marker-label ${colorClass}">${label}</div>`,
                    iconSize: [40, 22],
                    iconAnchor: [20, 11]
                });

                const marker = L.marker([tour.lat, tour.lon], { icon }).addTo(map);

                const depth = weather?.current?.snowDepth ?? '—';
                const temp = weather?.current?.temp ?? '—';

                marker.bindPopup(`
                    <div class="popup-title">${tour.name}</div>
                    <div class="popup-region">${tour.region}, ${tour.state}</div>
                    <div class="popup-stats">
                        <div><span>Depth:</span> ${depth}"</div>
                        <div><span>Temp:</span> ${temp}°F</div>
                        <div><span>Tmrw:</span> ${label}</div>
                        <div><span>Elev:</span> ${tour.elevation}'</div>
                    </div>
                    <button class="popup-detail-btn" onclick="openModal(tours.find(t=>t.id===${tour.id}))">View Details</button>
                `, { maxWidth: 220 });

                mapMarkers.push(marker);
                bounds.push([tour.lat, tour.lon]);
            });

            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [30, 30] });
            }
        }

        function switchView(view) {
            currentView = view;
            const mapContainer = document.getElementById('map-container');
            const toursContainer = document.getElementById('tours-container');
            const cardBtn = document.getElementById('card-view-btn');
            const mapBtn = document.getElementById('map-view-btn');
            const metricSelect = document.getElementById('map-metric-select');

            if (view === 'map') {
                mapContainer.classList.add('active');
                toursContainer.style.display = 'none';
                mapBtn.classList.add('active');
                cardBtn.classList.remove('active');
                metricSelect.style.display = '';
                initMap();
                setTimeout(() => {
                    map.invalidateSize();
                    updateMapMarkers();
                }, 100);
            } else {
                mapContainer.classList.remove('active');
                toursContainer.style.display = '';
                cardBtn.classList.add('active');
                mapBtn.classList.remove('active');
                metricSelect.style.display = 'none';
            }
        }

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            // Set initial theme
            setTheme(currentTheme);

            // Render tours
            renderTours();

            // Filter buttons (multi-select)
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const filter = btn.dataset.filter;
                    if (filter === 'all') {
                        // "All" deselects everything else
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    } else {
                        // Toggle this filter
                        btn.classList.toggle('active');
                        // Deactivate "All" if something else is active
                        document.querySelector('.filter-btn[data-filter="all"]').classList.remove('active');
                        // If nothing is selected, re-activate "All"
                        if (!document.querySelector('.filter-btn.active')) {
                            document.querySelector('.filter-btn[data-filter="all"]').classList.add('active');
                        }
                    }
                    applyFilters();
                });
            });

            // Search
            document.getElementById('search-input').addEventListener('input', applyFilters);

            // Sort
            document.getElementById('sort-select').addEventListener('change', applySorting);

            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', () => {
                setTheme(currentTheme === 'dark' ? 'light' : 'dark');
            });

            // Favorites toggle
            document.getElementById('favorites-toggle').addEventListener('click', () => {
                showFavoritesOnly = !showFavoritesOnly;
                document.getElementById('favorites-toggle').classList.toggle('active', showFavoritesOnly);
                applyFilters();
            });

            // View toggle
            document.getElementById('card-view-btn').addEventListener('click', () => switchView('card'));
            document.getElementById('map-view-btn').addEventListener('click', () => switchView('map'));

            // Map metric selector
            document.getElementById('map-metric-select').addEventListener('change', (e) => {
                mapMetric = e.target.value;
                if (currentView === 'map') updateMapMarkers();
            });

            // Modal close
            document.getElementById('modal-close').addEventListener('click', closeModal);
            document.getElementById('modal-overlay').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeModal();
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });

            // Register Service Worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New content available, show refresh prompt
                                    if (confirm('New version available! Reload to update?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            }

            // Handle iOS standalone mode
            if (window.navigator.standalone === true) {
                document.body.classList.add('ios-standalone');
            }

            // Handle URL params for shortcuts
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('filter') === 'favorites') {
                showFavoritesOnly = true;
                document.getElementById('favorites-toggle').classList.add('active');
                applyFilters();
            }

            // Show iOS install prompt if appropriate
            showInstallPromptIfNeeded();
        });

        // Handle online/offline status
        window.addEventListener('online', () => {
            document.body.classList.remove('offline');
            renderTours(); // Refresh data when back online
        });

        window.addEventListener('offline', () => {
            document.body.classList.add('offline');
        });

        // iOS Install Prompt Functions
        function showInstallPromptIfNeeded() {
            // Only show on iOS Safari, not in standalone mode, and if not dismissed
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isInStandaloneMode = window.navigator.standalone === true;
            const isDismissed = localStorage.getItem('install-prompt-dismissed');
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

            if (isIOS && isSafari && !isInStandaloneMode && !isDismissed) {
                setTimeout(() => {
                    document.getElementById('install-prompt').classList.add('show');
                }, 3000); // Show after 3 seconds
            }
        }

        function dismissInstallPrompt() {
            document.getElementById('install-prompt').classList.remove('show');
            localStorage.setItem('install-prompt-dismissed', 'true');
        }
    </script>
</body>
</html>
